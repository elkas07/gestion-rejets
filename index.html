
import React, { useState, useEffect } from 'react';
import { User, Rejet, ActivityLog, SaisieConfig } from './types';
import { supabaseService } from './services/supabase';
import { ChangePasswordModal } from './components/Modals/ChangePasswordModal';
import { AdminResetPasswordModal } from './components/Modals/AdminResetPasswordModal';

// Pages
import Dashboard from './pages/Dashboard';
import SaisiePage from './pages/SaisiePage';
import RejetsPage from './pages/RejetsPage';
import ValidationPage from './pages/ValidationPage';
import AdminPage from './pages/AdminPage';
import ReportsPage from './pages/ReportsPage';

const App: React.FC = () => {
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [currentUser, setCurrentUser] = useState<User | null>(null);
  const [currentPage, setCurrentPage] = useState('dashboard');
  const [showPwdModal, setShowPwdModal] = useState(false);
  const [isPublicPwdChange, setIsPublicPwdChange] = useState(false);
  
  const [loginData, setLoginData] = useState({ email: 'sramadan@ecobank.com', password: '', role: 'superviseur' as const });
  const [error, setError] = useState('');

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    try {
      const users = await supabaseService.getUsers();
      const user = users.find(u => u.email === loginData.email && u.role === loginData.role);
      
      if (user) {
        setIsLoggedIn(true);
        setCurrentUser(user);
        supabaseService.addLog({
          level: 'info',
          user: user.username,
          action: 'Connexion',
          details: `Utilisateur ${user.username} connecté avec succès`
        });
        
        if (user.force_password_change) {
          setShowPwdModal(true);
        }
      } else {
        setError("Identifiants ou rôle incorrects.");
      }
    } catch (err) {
      setError("Erreur de connexion au service.");
    }
  };

  const handleLogout = () => {
    setIsLoggedIn(false);
    setCurrentUser(null);
    setCurrentPage('dashboard');
  };

  const openPublicPwdChange = () => {
    setIsPublicPwdChange(true);
    setShowPwdModal(true);
  };

  if (!isLoggedIn) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-900 to-indigo-950 p-6">
        <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8">
          <div className="text-center mb-10">
            <div className="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-2xl text-blue-600 mb-4">
              <i className="fas fa-university text-3xl"></i>
            </div>
            <h1 className="text-2xl font-black text-slate-800 uppercase tracking-tighter">Gestion des Rejets</h1>
            <p className="text-slate-500 text-sm">Système de traçabilité OV/R/C - EcoBank</p>
          </div>

          <form onSubmit={handleLogin} className="space-y-6">
            {error && (
              <div className="p-3 bg-red-50 border border-red-100 text-red-700 text-sm rounded-lg flex items-center gap-2">
                <i className="fas fa-exclamation-triangle"></i>
                {error}
              </div>
            )}
            
            <div>
              <label className="block text-sm font-bold text-slate-700 mb-1.5 uppercase tracking-wide">Email professionnel</label>
              <div className="relative">
                <i className="fas fa-envelope absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                <input 
                  type="email" 
                  value={loginData.email}
                  onChange={e => setLoginData({...loginData, email: e.target.value})}
                  className="w-full bg-slate-50 border border-slate-200 rounded-xl pl-10 pr-4 py-3 focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition-all" 
                  placeholder="nom@ecobank.com"
                  required 
                />
              </div>
            </div>

            <div>
              <label className="block text-sm font-bold text-slate-700 mb-1.5 uppercase tracking-wide">Mot de passe</label>
              <div className="relative">
                <i className="fas fa-lock absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                <input 
                  type="password" 
                  value={loginData.password}
                  onChange={e => setLoginData({...loginData, password: e.target.value})}
                  className="w-full bg-slate-50 border border-slate-200 rounded-xl pl-10 pr-4 py-3 focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition-all" 
                  placeholder="••••••••"
                  required 
                />
              </div>
            </div>

            <div>
              <label className="block text-sm font-bold text-slate-700 mb-1.5 uppercase tracking-wide">Rôle assigné</label>
              <select 
                value={loginData.role}
                onChange={e => setLoginData({...loginData, role: e.target.value as any})}
                className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition-all"
              >
                <option value="agent">Agent OPS</option>
                <option value="superviseur">Superviseur</option>
                <option value="gestionnaire">Gestionnaire de Compte</option>
              </select>
            </div>

            <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-500/30 transition-all flex items-center justify-center gap-2">
              <i className="fas fa-sign-in-alt"></i> Se connecter
            </button>
          </form>

          <div className="mt-8 text-center">
            <button 
              onClick={openPublicPwdChange}
              className="text-blue-600 text-sm font-semibold hover:underline"
            >
              Modifier mon mot de passe
            </button>
          </div>
          
          <div className="mt-12 pt-6 border-t border-slate-100 text-center">
            <p className="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Accès réservé au personnel autorisé - v3.2</p>
          </div>
        </div>

        {showPwdModal && isPublicPwdChange && (
          <ChangePasswordModal 
            user={null} // Public mode
            onClose={() => {
              setShowPwdModal(false);
              setIsPublicPwdChange(false);
            }} 
          />
        )}
      </div>
    );
  }

  return (
    <div className="min-h-screen flex flex-col md:flex-row bg-slate-50">
      <aside className="w-full md:w-64 bg-slate-900 text-white flex-shrink-0 flex flex-col h-screen overflow-y-auto">
        <div className="p-6 flex items-center gap-3 border-b border-white/10">
          <div className="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
            <i className="fas fa-university text-xl"></i>
          </div>
          <div className="overflow-hidden">
            <h1 className="font-bold text-sm tracking-tight truncate">EcoBank SGR</h1>
            <p className="text-[10px] text-slate-400 uppercase tracking-widest">Gestion des Rejets</p>
          </div>
        </div>

        <nav className="p-4 space-y-2">
          <NavItem active={currentPage === 'dashboard'} icon="fa-tachometer-alt" label="Tableau de bord" onClick={() => setCurrentPage('dashboard')} />
          <NavItem active={currentPage === 'saisie'} icon="fa-plus-circle" label="Saisir un rejet" onClick={() => setCurrentPage('saisie')} />
          <NavItem active={currentPage === 'rejets'} icon="fa-list-ul" label="Liste des rejets" onClick={() => setCurrentPage('rejets')} />
          
          {(currentUser?.role === 'superviseur' || currentUser?.role === 'gestionnaire') && (
            <NavItem active={currentPage === 'validation'} icon="fa-check-double" label="Validation" onClick={() => setCurrentPage('validation')} />
          )}
          
          <NavItem active={currentPage === 'reports'} icon="fa-chart-pie" label="Rapports" onClick={() => setCurrentPage('reports')} />

          {currentUser?.role === 'superviseur' && (
            <NavItem active={currentPage === 'admin'} icon="fa-cogs" label="Administration" onClick={() => setCurrentPage('admin')} />
          )}
        </nav>

        <div className="mt-auto p-4 border-t border-white/10">
          <div className="bg-white/5 p-4 rounded-xl">
            <div className="flex items-center gap-3 mb-3">
              <div className="w-10 h-10 rounded-full bg-blue-500/20 border border-blue-500/30 flex items-center justify-center">
                <i className="fas fa-user-circle text-xl text-blue-400"></i>
              </div>
              <div className="overflow-hidden">
                <p className="text-sm font-bold truncate">{currentUser?.fullname}</p>
                <p className="text-[10px] text-slate-400 uppercase font-black">{currentUser?.role}</p>
              </div>
            </div>
            <button 
              onClick={() => {
                setIsPublicPwdChange(false);
                setShowPwdModal(true);
              }}
              className="w-full text-left text-xs text-slate-400 hover:text-white mb-2 flex items-center gap-2 px-2 py-1 rounded hover:bg-white/5"
            >
              <i className="fas fa-key text-[10px]"></i> Modifier mot de passe
            </button>
            <button 
              onClick={handleLogout}
              className="w-full bg-white/10 hover:bg-red-500/20 text-slate-300 hover:text-red-400 py-2 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2"
            >
              <i className="fas fa-power-off"></i> Déconnexion
            </button>
          </div>
        </div>
      </aside>

      <main className="flex-1 overflow-y-auto h-screen flex flex-col">
        <header className="bg-white border-b px-8 py-4 flex items-center justify-between flex-shrink-0">
          <h2 className="text-xl font-bold text-slate-800 capitalize">
            {currentPage === 'dashboard' ? 'Tableau de bord' : 
             currentPage === 'saisie' ? 'Nouveau Rejet' : 
             currentPage === 'rejets' ? 'Liste Historique' : 
             currentPage === 'validation' ? 'Validation Operations' :
             currentPage === 'reports' ? 'Statistiques & Analyse' : 'Administration'}
          </h2>
          <div className="flex items-center gap-4">
             <div className="text-xs text-slate-400 font-mono hidden md:block">
               {new Date().toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
             </div>
             <button className="w-10 h-10 rounded-full hover:bg-slate-100 flex items-center justify-center text-slate-500 relative">
               <i className="fas fa-bell"></i>
               <span className="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full"></span>
             </button>
          </div>
        </header>

        <div className="p-8 flex-1">
          {currentPage === 'dashboard' && <Dashboard user={currentUser!} />}
          {currentPage === 'saisie' && <SaisiePage user={currentUser!} onComplete={() => setCurrentPage('rejets')} />}
          {currentPage === 'rejets' && <RejetsPage user={currentUser!} />}
          {currentPage === 'validation' && <ValidationPage user={currentUser!} />}
          {currentPage === 'reports' && <ReportsPage />}
          {currentPage === 'admin' && <AdminPage user={currentUser!} />}
        </div>
      </main>

      {showPwdModal && !isPublicPwdChange && currentUser && (
        <ChangePasswordModal 
          user={currentUser} 
          onClose={() => setShowPwdModal(false)} 
        />
      )}
    </div>
  );
};

interface NavItemProps {
  active: boolean;
  icon: string;
  label: string;
  onClick: () => void;
}

const NavItem: React.FC<NavItemProps> = ({ active, icon, label, onClick }) => (
  <button 
    onClick={onClick}
    className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${
      active ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/20' : 'text-slate-400 hover:text-white hover:bg-white/5'
    }`}
  >
    <i className={`fas ${icon} w-5`}></i>
    <span className="text-sm font-semibold">{label}</span>
  </button>
);

export default App;

import React from 'react';

interface Props {
  password: string;
}

export const PasswordStrengthIndicator: React.FC<Props> = ({ password }) => {
  const hasLength = password.length >= 8;
  const hasUpper = /[A-Z]/.test(password);
  const hasLower = /[a-z]/.test(password);
  const hasNumber = /[0-9]/.test(password);

  const criteria = [
    { label: '8 caractères minimum', met: hasLength },
    { label: 'Une majuscule', met: hasUpper },
    { label: 'Une minuscule', met: hasLower },
    { label: 'Un chiffre', met: hasNumber },
  ];

  const metCount = criteria.filter(c => c.met).length;
  const strengthColor = metCount === 4 ? 'bg-green-500' : metCount >= 2 ? 'bg-yellow-500' : 'bg-red-500';
  const strengthText = metCount === 4 ? 'Fort' : metCount >= 2 ? 'Moyen' : 'Faible';

  return (
    <div className="mt-2 space-y-2">
      <div className="flex items-center gap-2">
        <div className="flex-1 h-2 bg-slate-200 rounded-full overflow-hidden">
          <div 
            className={`h-full transition-all duration-300 ${strengthColor}`} 
            style={{ width: `${(metCount / 4) * 100}%` }}
          />
        </div>
        <span className="text-xs font-semibold text-slate-500 uppercase">{strengthText}</span>
      </div>
      <div className="grid grid-cols-2 gap-x-4 gap-y-1">
        {criteria.map((c, i) => (
          <div key={i} className="flex items-center gap-1.5">
            <i className={`fas ${c.met ? 'fa-check-circle text-green-500' : 'fa-circle text-slate-300'} text-[10px]`} />
            <span className={`text-[11px] ${c.met ? 'text-green-700 font-medium' : 'text-slate-500'}`}>
              {c.label}
            </span>
          </div>
        ))}
      </div>
    </div>
  );
};

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoBank - Gestion des Rejets OV/R/C</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "recharts": "https://esm.sh/recharts@^3.6.0",
    "jspdf": "https://esm.sh/jspdf@^2.5.1",
    "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@^2.39.7"
  }
}
</script>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
    <div id="root"></div>
</body>
</html>

import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';

const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);
{
  "name": "EcoBank Rejection Management System",
  "description": "A comprehensive system for tracking and managing banking operation rejections (OV, R/C, PC) with workflow validation, advanced reporting, and user administration.",
  "requestFramePermissions": [
    "camera"
  ]
}
import React, { useState, useEffect } from 'react';
import { User, ActivityLog } from '../types';
import { supabaseService } from '../services/supabase';
import { AdminResetPasswordModal } from '../components/Modals/AdminResetPasswordModal';
import { AddUserModal } from '../components/Modals/AddUserModal';

interface Props {
  user: User;
}

const AdminPage: React.FC<Props> = ({ user }) => {
  const [users, setUsers] = useState<User[]>([]);
  const [logs, setLogs] = useState<ActivityLog[]>([]);
  const [activeTab, setActiveTab] = useState<'users' | 'logs'>('users');
  const [selectedUser, setSelectedUser] = useState<User | null>(null);
  const [showResetModal, setShowResetModal] = useState(false);
  const [showAddModal, setShowAddModal] = useState(false);

  const fetchData = () => {
    supabaseService.getUsers().then(setUsers);
    supabaseService.getLogs().then(setLogs);
  };

  useEffect(() => {
    fetchData();
  }, []);

  const handleResetPassword = (target: User) => {
    setSelectedUser(target);
    setShowResetModal(true);
  };

  return (
    <div className="space-y-6">
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div className="flex gap-4 border-b w-full md:w-auto">
          <button 
            onClick={() => setActiveTab('users')}
            className={`px-4 py-3 font-bold text-sm transition-all border-b-2 ${activeTab === 'users' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-400'}`}
          >
            Gestion Utilisateurs
          </button>
          <button 
            onClick={() => setActiveTab('logs')}
            className={`px-4 py-3 font-bold text-sm transition-all border-b-2 ${activeTab === 'logs' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-400'}`}
          >
            Journal d'activité
          </button>
        </div>

        {activeTab === 'users' && (
          <button 
            onClick={() => setShowAddModal(true)}
            className="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg shadow-emerald-500/20 flex items-center gap-2 transition-all hover:scale-105"
          >
            <i className="fas fa-user-plus"></i> Ajouter un Utilisateur
          </button>
        )}
      </div>

      {activeTab === 'users' ? (
        <div className="bg-white rounded-2xl shadow-sm border overflow-hidden">
          <table className="w-full text-left">
            <thead className="bg-slate-50 border-b">
              <tr>
                <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Utilisateur</th>
                <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Role</th>
                <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Departement</th>
                <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider text-right">Actions</th>
              </tr>
            </thead>
            <tbody className="divide-y">
              {users.map(u => (
                <tr key={u.id} className="hover:bg-slate-50 transition-colors group">
                  <td className="px-6 py-4">
                    <div className="flex items-center gap-3">
                      <div className="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 font-bold text-xs uppercase">
                        {u.fullname.charAt(0)}
                      </div>
                      <div>
                        <div className="font-bold text-slate-800">{u.fullname}</div>
                        <div className="text-xs text-slate-400">{u.email}</div>
                      </div>
                    </div>
                  </td>
                  <td className="px-6 py-4">
                    <span className={`text-[10px] font-black px-2 py-1 rounded uppercase tracking-wider border ${
                      u.role === 'superviseur' ? 'bg-indigo-50 text-indigo-600 border-indigo-100' : 
                      u.role === 'gestionnaire' ? 'bg-purple-50 text-purple-600 border-purple-100' : 'bg-blue-50 text-blue-600 border-blue-100'
                    }`}>
                      {u.role}
                    </span>
                  </td>
                  <td className="px-6 py-4 text-sm text-slate-600 font-medium capitalize">{u.departement}</td>
                  <td className="px-6 py-4 text-right">
                    <div className="flex justify-end gap-1 opacity-40 group-hover:opacity-100 transition-opacity">
                      <button 
                        onClick={() => handleResetPassword(u)}
                        className="w-8 h-8 rounded-lg text-slate-400 hover:text-blue-600 hover:bg-blue-50 flex items-center justify-center transition-all"
                        title="Réinitialiser mot de passe"
                      >
                        <i className="fas fa-key text-xs"></i>
                      </button>
                      <button className="w-8 h-8 rounded-lg text-slate-400 hover:text-red-500 hover:bg-red-50 flex items-center justify-center transition-all">
                        <i className="fas fa-trash text-xs"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      ) : (
        <div className="bg-white rounded-2xl shadow-sm border overflow-hidden">
          <table className="w-full text-left">
            <thead className="bg-slate-50 border-b">
              <tr>
                <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase">Timestamp</th>
                <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase">User</th>
                <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase">Action</th>
                <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase">Détails</th>
              </tr>
            </thead>
            <tbody className="divide-y">
              {logs.map(log => (
                <tr key={log.id} className="text-sm hover:bg-slate-50 transition-colors">
                  <td className="px-6 py-3 text-slate-400 font-mono text-[11px]">{new Date(log.timestamp).toLocaleString()}</td>
                  <td className="px-6 py-3 font-bold text-slate-700">{log.user}</td>
                  <td className="px-6 py-3">
                    <span className={`px-2 py-1 rounded text-[10px] font-black uppercase ${
                      log.level === 'security' ? 'bg-red-100 text-red-700' : 'bg-slate-100 text-slate-600'
                    }`}>
                      {log.action}
                    </span>
                  </td>
                  <td className="px-6 py-3 text-slate-500 italic">{log.details}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {showResetModal && selectedUser && (
        <AdminResetPasswordModal 
          targetUser={selectedUser} 
          adminUser={user} 
          onClose={() => {
            setShowResetModal(false);
            setSelectedUser(null);
          }} 
        />
      )}

      {showAddModal && (
        <AddUserModal 
          onClose={() => setShowAddModal(false)}
          onSuccess={() => {
            fetchData();
            setShowAddModal(false);
          }}
        />
      )}
    </div>
  );
};

export default AdminPage;

import React, { useState, useEffect } from 'react';
import { User, Rejet } from '../types';
import { supabaseService } from '../services/supabase';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell, PieChart, Pie } from 'recharts';

interface Props {
  user: User;
}

const Dashboard: React.FC<Props> = ({ user }) => {
  const [rejets, setRejets] = useState<Rejet[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    supabaseService.getRejets().then(data => {
      setRejets(data);
      setLoading(false);
    });
  }, []);

  // Using date_saisie instead of dateSaisie
  const stats = {
    today: rejets.filter(r => r.date_saisie === new Date().toISOString().split('T')[0]).length,
    month: rejets.filter(r => r.date_saisie.startsWith(new Date().toISOString().substring(0, 7))).length,
    pending: rejets.filter(r => r.statut === 'attente_validation' || r.statut === 'valide').length,
    total: rejets.length
  };

  const deptData = Object.entries(
    rejets.reduce((acc: Record<string, number>, r) => {
      acc[r.departement] = (acc[r.departement] || 0) + 1;
      return acc;
    }, {})
  ).map(([name, value]) => ({ name, value }));

  const statusData = [
    { name: 'Enregistré', value: rejets.filter(r => r.statut === 'enregistre').length, color: '#3b82f6' },
    { name: 'Validation', value: rejets.filter(r => r.statut === 'attente_validation').length, color: '#f59e0b' },
    { name: 'Transmis', value: rejets.filter(r => r.statut === 'transmis').length, color: '#8b5cf6' },
    { name: 'Terminé', value: rejets.filter(r => r.statut === 'recu').length, color: '#10b981' }
  ].filter(d => d.value > 0);

  return (
    <div className="space-y-8">
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <StatCard icon="fa-calendar-day" color="blue" label="Aujourd'hui" value={stats.today} trend="+2%" />
        <StatCard icon="fa-calendar-alt" color="indigo" label="Ce Mois" value={stats.month} trend="+12%" />
        <StatCard icon="fa-clock" color="orange" label="À Valider" value={stats.pending} trend="-4%" />
        <StatCard icon="fa-database" color="emerald" label="Total Rejets" value={stats.total} trend="+8%" />
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div className="bg-white p-6 rounded-2xl shadow-sm border">
          <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
            <i className="fas fa-chart-bar text-blue-500"></i> Par Département
          </h3>
          <div className="h-72">
            <ResponsiveContainer width="100%" height="100%">
              <BarChart data={deptData}>
                <CartesianGrid strokeDasharray="3 3" vertical={false} />
                <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{ fontSize: 12, fill: '#64748b' }} />
                <YAxis axisLine={false} tickLine={false} tick={{ fontSize: 12, fill: '#64748b' }} />
                <Tooltip cursor={{ fill: '#f8fafc' }} contentStyle={{ borderRadius: '12px', border: 'none', boxShadow: '0 10px 15px -3px rgba(0,0,0,0.1)' }} />
                <Bar dataKey="value" fill="#3b82f6" radius={[6, 6, 0, 0]} barSize={40} />
              </BarChart>
            </ResponsiveContainer>
          </div>
        </div>

        <div className="bg-white p-6 rounded-2xl shadow-sm border">
          <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
            <i className="fas fa-chart-pie text-blue-500"></i> Par Statut
          </h3>
          <div className="h-72 flex flex-col md:flex-row items-center">
            <div className="w-full md:w-1/2 h-full">
              <ResponsiveContainer width="100%" height="100%">
                <PieChart>
                  <Pie
                    data={statusData}
                    cx="50%"
                    cy="50%"
                    innerRadius={60}
                    outerRadius={80}
                    paddingAngle={5}
                    dataKey="value"
                  >
                    {statusData.map((entry, index) => (
                      <Cell key={`cell-${index}`} fill={entry.color} />
                    ))}
                  </Pie>
                  <Tooltip />
                </PieChart>
              </ResponsiveContainer>
            </div>
            <div className="w-full md:w-1/2 space-y-3">
              {statusData.map((d, i) => (
                <div key={i} className="flex items-center justify-between text-sm">
                  <div className="flex items-center gap-2">
                    <div className="w-3 h-3 rounded-full" style={{ backgroundColor: d.color }}></div>
                    <span className="text-slate-600 font-medium">{d.name}</span>
                  </div>
                  <span className="font-bold text-slate-800">{d.value}</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

const StatCard = ({ icon, color, label, value, trend }: any) => (
  <div className="bg-white p-6 rounded-2xl shadow-sm border hover:shadow-md transition-shadow">
    <div className="flex justify-between items-start mb-4">
      <div className={`w-12 h-12 rounded-xl bg-${color}-50 text-${color}-600 flex items-center justify-center text-xl`}>
        <i className={`fas ${icon}`}></i>
      </div>
      <span className="text-[10px] font-bold text-green-500 bg-green-50 px-2 py-1 rounded-lg uppercase">{trend}</span>
    </div>
    <p className="text-slate-500 text-xs font-bold uppercase tracking-widest mb-1">{label}</p>
    <p className="text-3xl font-black text-slate-800 tracking-tighter">{value}</p>
  </div>
);

export default Dashboard;

import React, { useState, useEffect } from 'react';
import { User, Rejet } from '../types';
import { supabaseService } from '../services/supabase';
import { ViewRejetModal } from '../components/Modals/ViewRejetModal';

interface Props {
  user: User;
}

const RejetsPage: React.FC<Props> = ({ user }) => {
  const [rejets, setRejets] = useState<Rejet[]>([]);
  const [filter, setFilter] = useState('');
  const [selectedRejet, setSelectedRejet] = useState<Rejet | null>(null);

  useEffect(() => {
    supabaseService.getRejets().then(data => {
      // If agent, show only their rejets unless they have permission
      if (user.role === 'agent' && !user.permissions.includes('view_all')) {
        setRejets(data.filter(r => r.agent_id === user.username));
      } else {
        setRejets(data);
      }
    });
  }, [user]);

  const handleExport = () => {
    if (rejets.length === 0) {
      alert("Aucune donnée à exporter.");
      return;
    }

    try {
      const headers = ["Date", "Reference", "Type", "Departement", "Client", "Compte", "Montant", "Statut", "Agent"];
      const csvRows = rejets.map(r => [
        new Date(r.date_saisie).toLocaleDateString(),
        r.reference,
        r.type,
        r.departement,
        r.client_nom.replace(/,/g, ' '),
        r.client_compte,
        r.montant,
        r.statut,
        r.agent_id
      ].join(';'));

      const csvContent = [headers.join(';'), ...csvRows].join('\n');
      const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', `Export_Rejets_EcoBank_${new Date().toISOString().split('T')[0]}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);
    } catch (error) {
      alert("Erreur lors de l'exportation : " + error);
    }
  };

  const handleOpenFilters = () => {
    alert("Le panneau des filtres avancés est en cours de développement.");
  };

  const filtered = rejets.filter(r => 
    r.reference.toLowerCase().includes(filter.toLowerCase()) ||
    r.client_nom.toLowerCase().includes(filter.toLowerCase())
  ).sort((a, b) => b.id - a.id);

  return (
    <div className="space-y-6">
      <div className="flex flex-col md:flex-row gap-4 items-center justify-between bg-white p-4 rounded-xl border">
        <div className="relative w-full md:w-96">
          <i className="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
          <input 
            type="text" 
            placeholder="Rechercher par référence ou client..."
            className="w-full pl-10 pr-4 py-2 bg-slate-50 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all"
            value={filter}
            onChange={e => setFilter(e.target.value)}
          />
        </div>
        <div className="flex gap-2 w-full md:w-auto">
          <button 
            onClick={handleOpenFilters}
            className="flex-1 md:flex-none px-4 py-2 border rounded-lg text-sm font-semibold hover:bg-slate-50 transition-colors"
          >
            <i className="fas fa-filter mr-2"></i> Filtres
          </button>
          <button 
            onClick={handleExport}
            className="flex-1 md:flex-none px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm font-semibold hover:bg-emerald-700 transition-colors shadow-md shadow-emerald-500/20 flex items-center justify-center gap-2"
          >
            <i className="fas fa-file-excel"></i> Exporter
          </button>
        </div>
      </div>

      <div className="bg-white rounded-2xl shadow-sm border overflow-hidden">
        <table className="w-full text-left">
          <thead className="bg-slate-50 border-b">
            <tr>
              <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase">Date</th>
              <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase">Référence</th>
              <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase">Client</th>
              <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase">Montant</th>
              <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase">Statut</th>
              <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase text-right">Actions</th>
            </tr>
          </thead>
          <tbody className="divide-y">
            {filtered.length === 0 ? (
              <tr>
                <td colSpan={6} className="px-6 py-12 text-center text-slate-400 italic">
                  Aucun rejet trouvé.
                </td>
              </tr>
            ) : (
              filtered.map(r => (
                <tr key={r.id} className="hover:bg-slate-50/50 transition-colors">
                  <td className="px-6 py-4 text-sm text-slate-600">{new Date(r.date_saisie).toLocaleDateString()}</td>
                  <td className="px-6 py-4 font-bold text-slate-800 tracking-tight">{r.reference}</td>
                  <td className="px-6 py-4">
                    <div className="text-sm font-semibold text-slate-700">{r.client_nom}</div>
                    <div className="text-[10px] text-slate-400 font-mono">{r.client_compte}</div>
                  </td>
                  <td className="px-6 py-4 font-bold text-blue-600 text-sm">
                    {r.montant.toLocaleString()} XAF
                  </td>
                  <td className="px-6 py-4">
                    <StatusBadge status={r.statut} />
                  </td>
                  <td className="px-6 py-4 text-right">
                    <button 
                      onClick={() => setSelectedRejet(r)}
                      className="w-10 h-10 rounded-full hover:bg-blue-50 text-slate-400 hover:text-blue-600 transition-all flex items-center justify-center mx-auto"
                      title="Voir les détails"
                    >
                      <i className="fas fa-eye text-lg"></i>
                    </button>
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>

      {selectedRejet && (
        <ViewRejetModal 
          rejet={selectedRejet} 
          onClose={() => setSelectedRejet(null)} 
        />
      )}
    </div>
  );
};

const StatusBadge = ({ status }: { status: string }) => {
  const styles: Record<string, string> = {
    enregistre: 'bg-blue-50 text-blue-600 border-blue-100',
    attente_validation: 'bg-amber-50 text-amber-600 border-amber-100',
    valide: 'bg-emerald-50 text-emerald-600 border-emerald-100',
    transmis: 'bg-purple-50 text-purple-600 border-purple-100',
    recu: 'bg-slate-100 text-slate-600 border-slate-200'
  };
  const labels: Record<string, string> = {
    enregistre: 'Enregistré',
    attente_validation: 'À Valider',
    valide: 'Validé',
    transmis: 'Transmis',
    recu: 'Finalisé'
  };

  return (
    <span className={`px-2 py-1 rounded text-[10px] font-black uppercase border ${styles[status] || styles.enregistre}`}>
      {labels[status] || status}
    </span>
  );
};

export default RejetsPage;

import React, { useState } from 'react';
import { jsPDF } from 'jspdf';
import { supabaseService } from '../services/supabase';

const ReportsPage: React.FC = () => {
  const [isGenerating, setIsGenerating] = useState(false);

  const generateProfessionalPDF = async () => {
    setIsGenerating(true);
    
    try {
      const doc = new jsPDF();
      const now = new Date();
      const dateStr = now.toLocaleDateString('fr-FR');
      const timeStr = now.toLocaleTimeString('fr-FR');

      // --- DESIGN DU HEADER ---
      // Background bleu EcoBank pour l'en-tête
      doc.setFillColor(0, 90, 156);
      doc.rect(0, 0, 210, 40, 'F');
      
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(22);
      doc.setFont('helvetica', 'bold');
      doc.text('ECOBANK SGR', 15, 25);
      
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.text('SYSTEME DE GESTION DES REJETS', 15, 32);
      
      doc.setFontSize(9);
      doc.text(`Généré le: ${dateStr} à ${timeStr}`, 140, 25);

      // --- TITRE DU RAPPORT ---
      doc.setTextColor(40, 40, 40);
      doc.setFontSize(16);
      doc.setFont('helvetica', 'bold');
      doc.text('RAPPORT DE SYNTHÈSE DES OPÉRATIONS', 15, 55);
      
      doc.setDrawColor(0, 90, 156);
      doc.setLineWidth(0.5);
      doc.line(15, 58, 100, 58);

      // --- RÉSUMÉ DES STATISTIQUES (Simulation de données) ---
      doc.setFontSize(11);
      doc.text('Statistiques de la période:', 15, 70);
      
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(10);
      doc.text('- Total des rejets enregistrés: 142', 20, 78);
      doc.text('- Rejets validés par superviseur: 128', 20, 84);
      doc.text('- En attente de traitement: 14', 20, 90);
      doc.text('- Montant total cumulé: 45,280,000 XAF', 20, 96);

      // --- TABLEAU SIMULÉ ---
      doc.setFillColor(240, 240, 240);
      doc.rect(15, 110, 180, 8, 'F');
      doc.setFont('helvetica', 'bold');
      doc.text('RÉFÉRENCE', 20, 115);
      doc.text('CLIENT', 60, 115);
      doc.text('MONTANT', 120, 115);
      doc.text('STATUT', 160, 115);

      doc.setFont('helvetica', 'normal');
      let y = 125;
      const samples = [
        { ref: 'REJ-OV-2023-045', client: 'SARL DISTRI-SUD', mt: '1,250,000', st: 'Finalisé' },
        { ref: 'REJ-RC-2023-046', client: 'ETS KOUAME & FILS', mt: '450,000', st: 'Transmis' },
        { ref: 'REJ-OV-2023-047', client: 'ONG ESPOIR CI', mt: '2,000,000', st: 'Validé' },
      ];

      samples.forEach(s => {
        doc.text(s.ref, 20, y);
        doc.text(s.client, 60, y);
        doc.text(s.mt, 120, y);
        doc.text(s.st, 160, y);
        y += 8;
      });

      // --- FOOTER ---
      doc.setFontSize(8);
      doc.setTextColor(150, 150, 150);
      doc.text('Document confidentiel à usage interne uniquement - EcoBank Operations Dept.', 105, 285, { align: 'center' });

      // Téléchargement
      doc.save(`Rapport_SGR_EcoBank_${Date.now()}.pdf`);
      
      await supabaseService.addLog({
        level: 'info',
        user: 'Utilisateur',
        action: 'Génération PDF',
        details: 'Rapport officiel généré via jsPDF'
      });

    } catch (error) {
      console.error(error);
      alert("Erreur lors de la génération du PDF.");
    } finally {
      setIsGenerating(false);
    }
  };

  const handleExportCSV = () => {
    const content = "Date;Reference;Client;Statut;Montant\n" + 
                    `${new Date().toLocaleDateString()};REJ-SIM-001;Simule Client;Valide;500000`;
    const blob = new Blob(["\ufeff" + content], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.setAttribute('download', `Rapport_Export_${Date.now()}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
  };

  const handleAction = () => {
    const formatSelect = document.getElementById('report-format') as HTMLSelectElement;
    if (formatSelect.value === 'PDF') {
      generateProfessionalPDF();
    } else {
      handleExportCSV();
    }
  };

  return (
    <div className="space-y-6 animate-in fade-in duration-500">
      <div className="bg-white p-8 rounded-2xl shadow-sm border text-center">
        <div className="w-20 h-20 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
          <i className="fas fa-file-invoice"></i>
        </div>
        <h2 className="text-2xl font-bold text-slate-800 mb-2">Génération de Rapports Officiels</h2>
        <p className="text-slate-500 mb-6 max-w-md mx-auto">
          Exportez vos données de rejets en format PDF sécurisé ou Excel.
        </p>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-2xl mx-auto text-left mb-8">
          <div>
            <label className="block text-[10px] font-black text-slate-400 uppercase mb-2">Période</label>
            <select className="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50">
              <option>Ce Mois</option>
              <option>Mois Dernier</option>
              <option>Trimestre</option>
            </select>
          </div>
          <div>
            <label className="block text-[10px] font-black text-slate-400 uppercase mb-2">Département</label>
            <select className="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50">
              <option>Tous les départements</option>
              <option>Corporate Banking</option>
              <option>SME Banking</option>
              <option>Operations (OPS)</option>
            </select>
          </div>
          <div>
            <label className="block text-[10px] font-black text-slate-400 uppercase mb-2">Format de sortie</label>
            <select id="report-format" className="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-blue-50 border-blue-100 font-bold">
              <option value="PDF">Fichier PDF (Standard)</option>
              <option value="CSV">Tableur Excel (CSV)</option>
            </select>
          </div>
        </div>

        <button 
          onClick={handleAction}
          disabled={isGenerating}
          className={`bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-10 rounded-xl shadow-lg shadow-blue-500/30 transition-all inline-flex items-center gap-3 ${isGenerating ? 'opacity-70 cursor-not-allowed' : 'hover:scale-105 active:scale-95'}`}
        >
          {isGenerating ? <i className="fas fa-circle-notch fa-spin"></i> : <i className="fas fa-file-export"></i>}
          {isGenerating ? 'Génération du PDF...' : 'Télécharger le Rapport'}
        </button>
      </div>

      <div className="bg-white p-6 rounded-2xl border shadow-sm">
        <h3 className="font-bold text-slate-800 flex items-center gap-2 mb-6">
          <i className="fas fa-history text-blue-500"></i> Historique des exports
        </h3>
        <div className="overflow-x-auto">
          <table className="w-full text-left">
            <thead className="bg-slate-50 text-[10px] font-black text-slate-400 uppercase">
              <tr>
                <th className="px-4 py-3">Nom du fichier</th>
                <th className="px-4 py-3">Format</th>
                <th className="px-4 py-3">Action</th>
              </tr>
            </thead>
            <tbody className="divide-y text-sm">
              <tr className="hover:bg-slate-50 group">
                <td className="px-4 py-3 font-semibold text-slate-700">Synthese_Hebdomadaire_S42</td>
                <td className="px-4 py-3"><span className="px-2 py-0.5 bg-red-100 text-red-600 rounded text-[10px] font-black uppercase">PDF</span></td>
                <td className="px-4 py-3">
                  <button onClick={generateProfessionalPDF} className="text-blue-600 font-bold hover:underline">Ré-éditer</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
};

export default ReportsPage;

import React, { useState } from 'react';
import { User, Rejet } from '../types';
import { supabaseService } from '../services/supabase';

interface Props {
  user: User;
  onComplete: () => void;
}

const SaisiePage: React.FC<Props> = ({ user, onComplete }) => {
  const [typesPieces] = useState(['OV', 'RC', 'PC']);
  const [departements] = useState(['Corporate', 'SME', 'Operations', 'Finance', 'VIP']);
  
  // Local state for motifs and charges to allow adding new ones during session
  const [motifs, setMotifs] = useState([
    'Provision insuffisante',
    'Signature non conforme',
    'Discordance montant',
    'Compte invalide',
    'Opposition',
    'RIB erroné'
  ]);
  const [charges, setCharges] = useState([
    'MHT NOUR',
    'ABOUBAKARY',
    'BIENVENUE'
  ]);

  // Updated formData keys to match Rejet interface
  const [formData, setFormData] = useState({
    type: 'OV',
    departement: '',
    charge: '',
    client_nom: '',
    client_compte: '',
    montant: 0,
    date_operation: new Date().toISOString().split('T')[0],
    motif: '',
    commentaire: ''
  });

  const [showOtherMotif, setShowOtherMotif] = useState(false);
  const [otherMotif, setOtherMotif] = useState('');
  
  const [showOtherCharge, setShowOtherCharge] = useState(false);
  const [otherCharge, setOtherCharge] = useState('');

  const handleMotifChange = (val: string) => {
    if (val === 'OTHER') {
      setShowOtherMotif(true);
      setFormData({ ...formData, motif: '' });
    } else {
      setShowOtherMotif(false);
      setFormData({ ...formData, motif: val });
    }
  };

  const handleChargeChange = (val: string) => {
    if (val === 'OTHER') {
      setShowOtherCharge(true);
      setFormData({ ...formData, charge: '' });
    } else {
      setShowOtherCharge(false);
      setFormData({ ...formData, charge: val });
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    const finalMotif = showOtherMotif ? otherMotif : formData.motif;
    const finalCharge = showOtherCharge ? otherCharge : formData.charge;

    if (!finalMotif || !finalCharge) {
      alert("Veuillez remplir tous les champs obligatoires.");
      return;
    }

    const reference = `REJ-${formData.type}-${new Date().getFullYear()}-${Math.floor(Math.random() * 1000).toString().padStart(3, '0')}`;
    
    // Construction of Rejet object with correct property names
    const newRejet: Rejet = {
      ...formData,
      motif: finalMotif,
      charge: finalCharge,
      id: Date.now(),
      reference,
      agent_id: user.username,
      date_saisie: new Date().toISOString().split('T')[0],
      statut: 'attente_validation',
      historique: [{
        action: 'enregistre',
        user: user.username,
        date: new Date().toISOString(),
        role: user.role
      }]
    };

    try {
      await supabaseService.saveRejet(newRejet);
      
      // If new motif/charge was added, update local lists for next time
      if (showOtherMotif && !motifs.includes(otherMotif)) setMotifs([...motifs, otherMotif]);
      if (showOtherCharge && !charges.includes(otherCharge)) setCharges([...charges, otherCharge]);

      await supabaseService.addLog({
        level: 'info',
        user: user.username,
        action: 'Création rejet',
        details: `Rejet créé: ${reference} pour le client ${formData.client_nom}`
      });
      alert(`Rejet enregistré avec la référence : ${reference}`);
      onComplete();
    } catch (err) {
      alert("Erreur lors de l'enregistrement du rejet.");
    }
  };

  return (
    <div className="bg-white rounded-2xl shadow-sm border p-8 max-w-4xl mx-auto">
      <div className="mb-6 flex items-center justify-between">
        <div>
          <h3 className="text-xl font-bold text-slate-800">Formulaire de Saisie</h3>
          <p className="text-sm text-slate-500">Remplissez les informations relatives à l'opération rejetée.</p>
        </div>
        <div className="text-right">
          <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Saisie par</span>
          <p className="text-sm font-bold text-blue-600">{user.fullname}</p>
        </div>
      </div>

      <form onSubmit={handleSubmit} className="space-y-6">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Type de pièce</label>
            <select 
              value={formData.type}
              onChange={e => setFormData({...formData, type: e.target.value})}
              className="w-full bg-slate-50 border rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500"
            >
              {typesPieces.map(t => <option key={t} value={t}>{t}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Département émetteur</label>
            <select 
              value={formData.departement}
              onChange={e => setFormData({...formData, departement: e.target.value})}
              className="w-full bg-slate-50 border rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500"
              required
            >
              <option value="">Sélectionnez un département...</option>
              {departements.map(d => <option key={d} value={d}>{d}</option>)}
            </select>
          </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Nom du Client</label>
            <input 
              type="text" 
              value={formData.client_nom}
              onChange={e => setFormData({...formData, client_nom: e.target.value})}
              className="w-full bg-slate-50 border rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Ex: SARL DISTRIBUTION SUD"
              required
            />
          </div>
          <div>
            <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Numéro de Compte</label>
            <input 
              type="text" 
              value={formData.client_compte}
              onChange={e => setFormData({...formData, client_compte: e.target.value})}
              className="w-full bg-slate-50 border rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Format: 11 chiffres"
              required
            />
          </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Montant (XAF)</label>
            <input 
              type="number" 
              value={formData.montant || ''}
              onChange={e => setFormData({...formData, montant: parseFloat(e.target.value)})}
              className="w-full bg-slate-50 border rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 font-bold text-blue-600"
              placeholder="0.00"
              required
            />
          </div>
          <div>
            <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Motif de rejet</label>
            <div className="space-y-2">
              <select 
                value={showOtherMotif ? 'OTHER' : formData.motif}
                onChange={e => handleMotifChange(e.target.value)}
                className="w-full bg-slate-50 border rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500"
                required={!showOtherMotif}
              >
                <option value="">Sélectionnez un motif...</option>
                {motifs.map(m => <option key={m} value={m}>{m}</option>)}
                <option value="OTHER" className="font-bold text-blue-600">+ Ajouter un nouveau motif...</option>
              </select>
              {showOtherMotif && (
                <div className="flex gap-2">
                  <input 
                    type="text"
                    value={otherMotif}
                    onChange={e => setOtherMotif(e.target.value)}
                    className="flex-1 bg-white border border-blue-200 rounded-xl px-4 py-2 outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Saisir le nouveau motif..."
                    required
                  />
                  <button 
                    type="button" 
                    onClick={() => setShowOtherMotif(false)}
                    className="p-2 text-slate-400 hover:text-slate-600"
                  >
                    <i className="fas fa-times"></i>
                  </button>
                </div>
              )}
            </div>
          </div>
        </div>

        <div>
          <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Chargé à notifier</label>
          <div className="space-y-2">
            <select 
              value={showOtherCharge ? 'OTHER' : formData.charge}
              onChange={e => handleChargeChange(e.target.value)}
              className="w-full bg-slate-50 border rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500"
              required={!showOtherCharge}
            >
              <option value="">Sélectionnez un responsable...</option>
              {charges.map(c => <option key={c} value={c}>{c}</option>)}
              <option value="OTHER" className="font-bold text-blue-600">+ Ajouter un nouveau chargé...</option>
            </select>
            {showOtherCharge && (
              <div className="flex gap-2">
                <input 
                  type="text"
                  value={otherCharge}
                  onChange={e => setOtherCharge(e.target.value)}
                  className="flex-1 bg-white border border-blue-200 rounded-xl px-4 py-2 outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Saisir le nom du chargé..."
                  required
                />
                <button 
                  type="button" 
                  onClick={() => setShowOtherCharge(false)}
                  className="p-2 text-slate-400 hover:text-slate-600"
                >
                  <i className="fas fa-times"></i>
                </button>
              </div>
            )}
          </div>
        </div>

        <div>
          <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Commentaires additionnels</label>
          <textarea 
            value={formData.commentaire}
            onChange={e => setFormData({...formData, commentaire: e.target.value})}
            className="w-full bg-slate-50 border rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 min-h-[100px]"
            placeholder="Précisez les détails du rejet si nécessaire..."
          />
        </div>

        <div className="pt-6 flex justify-end gap-4 border-t">
          <button 
            type="button" 
            onClick={() => onComplete()}
            className="px-8 py-3 font-bold text-slate-500 hover:text-slate-700 transition-colors"
          >
            Annuler
          </button>
          <button 
            type="submit" 
            className="px-10 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg shadow-blue-500/30 transition-all flex items-center gap-2"
          >
            <i className="fas fa-paper-plane"></i> Soumettre pour validation
          </button>
        </div>
      </form>
    </div>
  );
};

export default SaisiePage;

import React, { useState, useEffect } from 'react';
import { User, Rejet } from '../types';
import { supabaseService } from '../services/supabase';

interface Props {
  user: User;
}

const ValidationPage: React.FC<Props> = ({ user }) => {
  const [rejets, setRejets] = useState<Rejet[]>([]);

  useEffect(() => {
    supabaseService.getRejets().then(data => {
      // Supervisors see rejets waiting for validation
      if (user.role === 'superviseur') {
        setRejets(data.filter(r => r.statut === 'attente_validation' || r.statut === 'valide'));
      } else if (user.role === 'gestionnaire') {
        setRejets(data.filter(r => r.statut === 'transmis'));
      }
    });
  }, [user]);

  const handleAction = async (rejet: Rejet, nextStatut: Rejet['statut'], actionLabel: string) => {
    if (!confirm(`Confirmer l'action : ${actionLabel} ?`)) return;

    const updated: Rejet = {
      ...rejet,
      statut: nextStatut,
      historique: [...rejet.historique, {
        action: nextStatut,
        user: user.username,
        date: new Date().toISOString(),
        role: user.role
      }]
    };

    await supabaseService.saveRejet(updated);
    await supabaseService.addLog({
      level: 'info',
      user: user.username,
      action: actionLabel,
      details: `Rejet ${rejet.reference} passé au statut ${nextStatut}`
    });

    setRejets(prev => prev.filter(r => r.id !== rejet.id));
    alert(`Action "${actionLabel}" effectuée avec succès.`);
  };

  return (
    <div className="bg-white rounded-2xl shadow-sm border overflow-hidden">
      <div className="p-6 border-b bg-slate-50 flex justify-between items-center">
        <h3 className="font-bold text-slate-800">Rejets en attente de traitement</h3>
        <span className="bg-blue-100 text-blue-700 text-xs font-black px-2 py-1 rounded-full">{rejets.length} À TRAITER</span>
      </div>
      <table className="w-full text-left">
        <thead className="bg-white border-b">
          <tr>
            <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase">Référence</th>
            <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase">Agent</th>
            <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase">Montant</th>
            <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase">Motif</th>
            <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase text-right">Décision</th>
          </tr>
        </thead>
        <tbody className="divide-y">
          {rejets.length === 0 ? (
            <tr><td colSpan={5} className="px-6 py-12 text-center text-slate-400 italic">Tout est à jour !</td></tr>
          ) : (
            rejets.map(r => (
              <tr key={r.id} className="hover:bg-slate-50 transition-colors">
                <td className="px-6 py-4">
                  <div className="font-bold text-slate-800">{r.reference}</div>
                  <div className="text-[10px] text-slate-400 uppercase font-bold">{r.type}</div>
                </td>
                <td className="px-6 py-4 text-sm text-slate-600">{r.agent_id}</td>
                <td className="px-6 py-4 font-bold text-slate-700">{r.montant.toLocaleString()} XAF</td>
                <td className="px-6 py-4 text-xs text-slate-500 max-w-xs">{r.motif}</td>
                <td className="px-6 py-4 text-right flex justify-end gap-2">
                  {user.role === 'superviseur' && r.statut === 'attente_validation' && (
                    <>
                      <button 
                        onClick={() => handleAction(r, 'valide', 'Validation Superviseur')}
                        className="px-3 py-1.5 bg-green-600 text-white rounded-lg text-xs font-bold hover:bg-green-700"
                      >
                        Valider
                      </button>
                      <button className="px-3 py-1.5 bg-red-600 text-white rounded-lg text-xs font-bold hover:bg-red-700">Rejeter</button>
                    </>
                  )}
                  {user.role === 'superviseur' && r.statut === 'valide' && (
                    <button 
                      onClick={() => handleAction(r, 'transmis', 'Transmission Gestionnaire')}
                      className="px-3 py-1.5 bg-blue-600 text-white rounded-lg text-xs font-bold hover:bg-blue-700"
                    >
                      Transmettre
                    </button>
                  )}
                  {user.role === 'gestionnaire' && r.statut === 'transmis' && (
                    <button 
                      onClick={() => handleAction(r, 'recu', 'Confirmation Réception')}
                      className="px-3 py-1.5 bg-emerald-600 text-white rounded-lg text-xs font-bold hover:bg-emerald-700"
                    >
                      Confirmer Réception
                    </button>
                  )}
                </td>
              </tr>
            ))
          )}
        </tbody>
      </table>
    </div>
  );
};

export default ValidationPage;

import { createClient } from '@supabase/supabase-js';
import { User, Rejet, ActivityLog } from '../types';

const supabaseUrl = 'https://qldfjdmpzvyhgsmepynp.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFsZGZqZG1wenZ5aGdzbWVweW5wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0OTU3NTEsImV4cCI6MjA4NDA3MTc1MX0.xAm9RrmzMCuxMfu4xjygPZMyiNbJqSXH9L_GNegbiBI';

export const supabase = createClient(supabaseUrl, supabaseKey);

export const supabaseService = {
  // --- GESTION DES UTILISATEURS ---
  getUsers: async (): Promise<User[]> => {
    const { data, error } = await supabase
      .from('users')
      .select('*')
      .order('fullname', { ascending: true });
    
    if (error) {
      console.error('Error fetching users:', error);
      return [];
    }
    return data as User[];
  },

  addUser: async (userData: Omit<User, 'id' | 'created_at' | 'status'>) => {
    const { data, error } = await supabase
      .from('users')
      .insert([{
        ...userData,
        status: 'active'
      }])
      .select()
      .single();

    if (error) throw error;
    return { success: true, user: data };
  },

  updateUser: async (userId: string, data: Partial<User>) => {
    const { error } = await supabase
      .from('users')
      .update(data)
      .eq('id', userId);

    if (error) throw error;
    return { success: true };
  },

  // --- GESTION DES REJETS ---
  getRejets: async (): Promise<Rejet[]> => {
    const { data, error } = await supabase
      .from('rejets')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) {
      console.error('Error fetching rejets:', error);
      return [];
    }
    return data as Rejet[];
  },

  saveRejet: async (rejet: Rejet) => {
    const { error } = await supabase
      .from('rejets')
      .upsert(rejet);

    if (error) throw error;
    return { success: true };
  },

  // --- GESTION DES LOGS ---
  getLogs: async (): Promise<ActivityLog[]> => {
    const { data, error } = await supabase
      .from('journal_activite')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(100);

    if (error) {
      console.error('Error fetching logs:', error);
      return [];
    }
    return data.map(log => ({
      ...log,
      timestamp: log.created_at,
      level: log.niveau || 'info'
    })) as ActivityLog[];
  },

  addLog: async (log: Omit<ActivityLog, 'id' | 'timestamp' | 'ip'>) => {
    const { error } = await supabase
      .from('journal_activite')
      .insert([{
        niveau: log.level,
        user_id: log.user, // On stocke l'identifiant de l'utilisateur
        action: log.action,
        details: log.details,
        ip_address: '127.0.0.1' // Idéalement récupéré côté serveur
      }]);

    if (error) console.error('Error saving log:', error);
    return { success: !error };
  }
};

export type UserRole = 'agent' | 'superviseur' | 'gestionnaire';

export interface User {
  id: string;
  username: string;
  fullname: string;
  email: string;
  role: UserRole;
  departement: string; // Ou departement_id selon vos besoins de mapping
  status: 'active' | 'suspended' | 'inactive';
  permissions: string[];
  created_at: string;
  force_password_change?: boolean;
}

export interface Rejet {
  id: number;
  reference: string;
  type: string;
  departement: string;
  charge: string;
  client_nom: string;
  client_compte: string;
  montant: number;
  date_operation: string;
  motif: string;
  commentaire: string;
  agent_id: string;
  date_saisie: string;
  statut: 'enregistre' | 'attente_validation' | 'valide' | 'transmis' | 'recu';
  historique: HistoriqueItem[];
}

export interface HistoriqueItem {
  action: string;
  user: string;
  date: string;
  role: string;
}

export interface ActivityLog {
  id: number;
  timestamp: string;
  level: 'info' | 'warning' | 'error' | 'security';
  user: string;
  action: string;
  details: string;
  ip: string;
}

export interface SaisieConfig {
  types_pieces: string[];
  departements: string[];
  motifs: string[];
  charges: { id: string; nom: string; departement: string }[];
}

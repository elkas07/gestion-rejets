<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Rejets OV/R/C - Banque</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Ajout du script Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* [Tous les styles CSS restent exactement les m√™mes] */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* Header */
        header {
            background: linear-gradient(90deg, #1a237e 0%, #283593 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            font-size: 2rem;
            color: #5c6bc0;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-badge {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .language-selector select {
            background: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 12px;
            border-radius: 5px;
        }

        /* Main Layout */
        .main-layout {
            display: flex;
            min-height: 800px;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: #f8f9fa;
            border-right: 1px solid #eaeaea;
            padding: 25px 0;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        .nav-item:hover {
            background: #eef2ff;
        }

        .nav-item.active {
            background: #e8eaf6;
            border-left: 4px solid #3f51b5;
            color: #3f51b5;
            font-weight: 600;
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 25px;
        }

        .page-title {
            font-size: 1.8rem;
            color: #1a237e;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eaeaea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title-actions {
            display: flex;
            gap: 10px;
        }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-left: 5px solid #5c6bc0;
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card .value {
            font-size: 2.2rem;
            font-weight: 700;
            color: #1a237e;
            margin-bottom: 10px;
        }

        .card .trend {
            font-size: 0.9rem;
            color: #4caf50;
        }

        .card .trend.down {
            color: #f44336;
        }

        /* Charts Container */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-box {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .chart-title {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-title i {
            color: #5c6bc0;
        }

        /* Form Styles */
        .form-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border 0.3s;
        }

        .form-control:focus {
            border-color: #5c6bc0;
            outline: none;
            box-shadow: 0 0 0 2px rgba(92, 107, 192, 0.2);
        }

        select.form-control {
            appearance: none;
            background: white url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") no-repeat right 10px center;
            background-size: 16px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #3f51b5;
            color: white;
        }

        .btn-primary:hover {
            background: #303f9f;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background: #388e3c;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-warning:hover {
            background: #f57c00;
        }

        .btn-info {
            background: #2196f3;
            color: white;
        }

        .btn-info:hover {
            background: #1976d2;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        /* Table Styles */
        .table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eaeaea;
        }

        .filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f1f3f9;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #444;
            border-bottom: 2px solid #eaeaea;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f9f9ff;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-enregistre {
            background: #e3f2fd;
            color: #1565c0;
        }

        .status-attente-validation {
            background: #fff3e0;
            color: #ef6c00;
        }

        .status-valide {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-transmis {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .status-recu {
            background: #e8f5e9;
            color: #1b5e20;
        }

        .btn-icon {
            background: transparent;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
        }

        .btn-icon:hover {
            background: #f0f0f0;
        }

        /* Workflow Visualization */
        .workflow-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            position: relative;
        }

        .workflow-step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
            border: 3px solid #e0e0e0;
        }

        .step-circle.active {
            background: #3f51b5;
            color: white;
            border-color: #3f51b5;
        }

        .step-circle.completed {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }

        .step-label {
            font-size: 0.85rem;
            color: #666;
        }

        .workflow-line {
            position: absolute;
            top: 20px;
            left: 10%;
            right: 10%;
            height: 3px;
            background: #e0e0e0;
            z-index: 0;
        }

        .workflow-line-fill {
            position: absolute;
            top: 20px;
            left: 10%;
            height: 3px;
            background: #4caf50;
            z-index: 0;
            transition: width 0.3s;
        }

        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }

        .login-box {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            padding: 40px;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 30px;
            color: #1a237e;
        }

        .login-logo i {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .login-logo h1 {
            font-size: 1.8rem;
        }

        .login-form .form-group {
            margin-bottom: 20px;
        }

        .login-footer {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-size: 0.9rem;
        }

        /* Changement mot de passe */
        .change-password-link {
            text-align: center;
            margin-top: 15px;
        }

        .change-password-link a {
            color: #3f51b5;
            text-decoration: none;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .change-password-link a:hover {
            text-decoration: underline;
        }

        /* Rapport PDF Styles */
        .rapport-container {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .rapport-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #1a237e;
            padding-bottom: 20px;
        }

        .rapport-header h2 {
            color: #1a237e;
            margin-bottom: 10px;
        }

        .rapport-period {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .rapport-statistiques {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .rapport-stat {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .rapport-stat .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1a237e;
            margin: 10px 0;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eaeaea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #eaeaea;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #eaeaea;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #666;
        }

        .tab.active {
            color: #3f51b5;
            border-bottom-color: #3f51b5;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Configuration Grid */
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .config-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #eaeaea;
        }

        .config-card h4 {
            margin-bottom: 15px;
            color: #1a237e;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eaeaea;
        }

        .config-item:last-child {
            border-bottom: none;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4caf50;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Barre de d√©filement et pagination */
        .table-scroll-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #eaeaea;
        }

        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .pagination-info {
            font-size: 0.9rem;
            color: #666;
        }

        .pagination-buttons {
            display: flex;
            gap: 5px;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            min-width: 40px;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #eef2ff;
            border-color: #5c6bc0;
        }

        .pagination-btn.active {
            background: #3f51b5;
            color: white;
            border-color: #3f51b5;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .rows-per-page {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Responsive */
        @media (max-width: 992px) {
            .main-layout {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #eaeaea;
            }
            
            .nav-menu {
                display: flex;
                overflow-x: auto;
            }
            
            .nav-item {
                white-space: nowrap;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .workflow-steps {
                flex-direction: column;
                gap: 20px;
            }
            
            .workflow-line {
                display: none;
            }
            
            .page-title {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .page-title-actions {
                width: 100%;
                justify-content: flex-start;
            }

            .pagination-controls {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 768px) {
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .table-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .filters {
                width: 100%;
            }
            
            .filter-input {
                flex: 1;
            }
            
            .config-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="app-container">
        <!-- Login Screen (shown by default) -->
        <div id="login-screen">
            <div class="login-container">
                <div class="login-box">
                    <div class="login-logo">
                        <i class="fas fa-university"></i>
                        <h1>Gestion des Rejets</h1>
                        <p>Syst√®me de tra√ßabilit√© OV/R/C</p>
                    </div>
                    <form id="loginForm" class="login-form">
                        <div class="form-group">
                            <label for="loginEmail">Email</label>
                            <input type="email" id="loginEmail" class="form-control" placeholder="Votre email" required>
                        </div>
                        <div class="form-group">
                            <label for="loginPassword">Mot de passe</label>
                            <input type="password" id="loginPassword" class="form-control" placeholder="Votre mot de passe" required>
                        </div>
                        <div class="form-group">
                            <label for="loginRole">R√¥le</label>
                            <select id="loginRole" class="form-control">
                                <option value="agent">Agent OPS</option>
                                <option value="superviseur">Superviseur</option>
                                <option value="gestionnaire">Gestionnaire de Compte</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="loginLanguage">Langue</label>
                            <select id="loginLanguage" class="form-control">
                                <option value="fr">Fran√ßais</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                            <i class="fas fa-sign-in-alt"></i> Se connecter
                        </button>
                    </form>
                    
                    <!-- Lien pour changer le mot de passe -->
                    <div class="change-password-link">
                        <a id="change-password-link">Changer mon mot de passe</a>
                    </div>
                    
                    <div class="login-footer">
                        <p>Acc√®s r√©serv√© au personnel autoris√©</p>
                        <p><small>Version 3.0 - Administration compl√®te</small></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Application (hidden by default) -->
        <div id="main-app" style="display: none;">
            <!-- [Tout le reste du code reste exactement le m√™me] -->
            <header>
                <div class="logo">
                    <i class="fas fa-university"></i>
                    <div>
                        <h1>Syst√®me de Gestion des Rejets</h1>
                        <p>Workflow de validation OV/R/C</p>
                    </div>
                </div>
                <div class="user-info">
                    <div class="user-badge">
                        <i class="fas fa-user-circle"></i>
                        <span id="current-user">Agent OPS</span>
                    </div>
                    <div class="language-selector">
                        <select id="language-switcher">
                            <option value="fr">üá´üá∑ Fran√ßais</option>
                            <option value="en">üá¨üáß English</option>
                        </select>
                    </div>
                    <button id="logout-btn" class="btn btn-secondary" style="padding: 8px 15px;">
                        <i class="fas fa-sign-out-alt"></i> D√©connexion
                    </button>
                </div>
            </header>

            <div class="main-layout">
                <!-- Sidebar Navigation -->
                <nav class="sidebar">
                    <ul class="nav-menu">
                        <li class="nav-item active" data-page="dashboard">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Tableau de bord</span>
                        </li>
                        <li class="nav-item" data-page="saisie">
                            <i class="fas fa-plus-circle"></i>
                            <span>Saisir un rejet</span>
                        </li>
                        <li class="nav-item" data-page="rejets">
                            <i class="fas fa-list"></i>
                            <span>Liste des rejets</span>
                        </li>
                        <li class="nav-item" data-page="validation" id="validation-nav" style="display: none;">
                            <i class="fas fa-check-circle"></i>
                            <span>Validation</span>
                        </li>
                        <li class="nav-item" data-page="rapports" id="rapports-nav">
                            <i class="fas fa-chart-bar"></i>
                            <span>Rapports d√©taill√©s</span>
                        </li>
                        <li class="nav-item" data-page="administration" id="admin-nav" style="display: none;">
                            <i class="fas fa-cog"></i>
                            <span>Administration</span>
                        </li>
                    </ul>
                </nav>

                <!-- Main Content Area -->
                <main class="main-content">
                    <!-- Dashboard Page -->
                    <div id="dashboard-page" class="page-content">
                        <h2 class="page-title">
                            <i class="fas fa-tachometer-alt"></i> Tableau de bord
                            <div class="page-title-actions">
                                <button class="btn btn-secondary" id="quick-report">
                                    <i class="fas fa-file-pdf"></i> Rapport rapide
                                </button>
                            </div>
                        </h2>
                        
                        <!-- KPI Cards -->
                        <div class="dashboard-cards">
                            <div class="card">
                                <h3>Rejets aujourd'hui</h3>
                                <div class="value" id="rejets-today">0</div>
                                <div class="trend">+0% vs hier</div>
                            </div>
                            <div class="card">
                                <h3>Rejets ce mois</h3>
                                <div class="value" id="rejets-month">0</div>
                                <div class="trend">+0% vs mois dernier</div>
                            </div>
                            <div class="card">
                                <h3>√Ä valider</h3>
                                <div class="value" id="a-valider">0</div>
                                <div class="trend" id="a-valider-trend">Attente superviseur</div>
                            </div>
                            <div class="card">
                                <h3>Taux de validation</h3>
                                <div class="value" id="taux-validation">0%</div>
                                <div class="trend">Moyenne mensuelle</div>
                            </div>
                        </div>
                        
                        <!-- Charts -->
                        <div class="charts-container">
                            <div class="chart-box">
                                <h3 class="chart-title">
                                    <i class="fas fa-chart-pie"></i> R√©partition par statut
                                </h3>
                                <canvas id="statutChart"></canvas>
                            </div>
                            <div class="chart-box">
                                <h3 class="chart-title">
                                    <i class="fas fa-chart-bar"></i> Rejets par d√©partement
                                </h3>
                                <canvas id="departementChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Top Clients -->
                        <div class="chart-box">
                            <h3 class="chart-title">
                                <i class="fas fa-exclamation-triangle"></i> Top 5 clients avec rejets r√©currents
                            </h3>
                            <div id="top-clients-list">
                                <p>Aucune donn√©e disponible. Saisissez des rejets pour voir les statistiques.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Saisie Page -->
                    <div id="saisie-page" class="page-content" style="display: none;">
                        <h2 class="page-title">
                            <i class="fas fa-plus-circle"></i> Saisir un nouveau rejet
                        </h2>
                        
                        <div class="form-container">
                            <form id="rejet-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="type-piece">Type de pi√®ce *</label>
                                        <select id="type-piece" class="form-control" required>
                                            <option value="">S√©lectionnez...</option>
                                            <!-- Options charg√©es dynamiquement depuis la configuration -->
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="reference">Num√©ro de r√©f√©rence *</label>
                                        <input type="text" id="reference" class="form-control" readonly value="G√©n√©r√© automatiquement">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="departement">D√©partement √©metteur *</label>
                                        <select id="departement" class="form-control" required>
                                            <option value="">S√©lectionnez...</option>
                                            <!-- Options charg√©es dynamiquement depuis la configuration -->
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="charge">Charg√© √† notifier *</label>
                                        <div style="display: flex; gap: 10px;">
                                            <select id="charge" class="form-control" required>
                                                <option value="">S√©lectionnez...</option>
                                                <!-- Options charg√©es dynamiquement depuis la configuration -->
                                            </select>
                                            <button type="button" id="add-charge-btn" class="btn btn-secondary">
                                                <i class="fas fa-plus"></i> Ajouter
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="client-nom">Nom du client</label>
                                        <input type="text" id="client-nom" class="form-control" placeholder="Nom complet du client">
                                    </div>
                                    <div class="form-group">
                                        <label for="client-compte">N¬∞ de compte client</label>
                                        <input type="text" id="client-compte" class="form-control" placeholder="0123456789">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="montant">Montant * (MAD)</label>
                                        <input type="number" id="montant" class="form-control" placeholder="0.00" step="0.01" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="date-operation">Date de l'op√©ration *</label>
                                        <input type="date" id="date-operation" class="form-control" required>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="motif">Motif de rejet *</label>
                                        <div style="display: flex; gap: 10px;">
                                            <select id="motif" class="form-control" required>
                                                <option value="">S√©lectionnez...</option>
                                                <!-- Options charg√©es dynamiquement depuis la configuration -->
                                            </select>
                                            <button type="button" id="add-motif-btn" class="btn btn-secondary">
                                                <i class="fas fa-plus"></i> Autre
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Champs suppl√©mentaires selon configuration -->
                                <div id="additional-fields">
                                    <!-- Champs suppl√©mentaires charg√©s dynamiquement -->
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="commentaire">Commentaire suppl√©mentaire</label>
                                        <textarea id="commentaire" class="form-control" rows="3" placeholder="D√©tails suppl√©mentaires sur le rejet..."></textarea>
                                    </div>
                                </div>
                                
                                <!-- Workflow Visualization -->
                                <div class="workflow-steps">
                                    <div class="workflow-line"></div>
                                    <div class="workflow-line-fill" id="workflow-progress" style="width: 20%;"></div>
                                    
                                    <div class="workflow-step">
                                        <div class="step-circle active">1</div>
                                        <div class="step-label">Enregistrement Agent OPS</div>
                                    </div>
                                    <div class="workflow-step">
                                        <div class="step-circle">2</div>
                                        <div class="step-label">Validation Superviseur</div>
                                    </div>
                                    <div class="workflow-step">
                                        <div class="step-circle">3</div>
                                        <div class="step-label">R√©ception Gestionnaire</div>
                                    </div>
                                    <div class="workflow-step">
                                        <div class="step-circle">4</div>
                                        <div class="step-label">Cl√¥tur√©</div>
                                    </div>
                                </div>
                                
                                <div class="form-actions">
                                    <button type="button" class="btn btn-secondary" id="cancel-btn">
                                        <i class="fas fa-times"></i> Annuler
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Enregistrer et soumettre
                                    </button>
                                </div>
                                
                                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                                    <p><strong>Agent rejeteur :</strong> <span id="current-agent">[Nom de l'agent]</span></p>
                                    <p><small>Ce rejet sera soumis au superviseur pour validation.</small></p>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Liste des Rejets Page -->
                    <div id="rejets-page" class="page-content" style="display: none;">
                        <h2 class="page-title">
                            <i class="fas fa-list"></i> Liste des rejets
                        </h2>
                        
                        <div class="table-container">
                            <div class="table-header">
                                <h3 style="margin: 0;">Historique des rejets</h3>
                                <div class="filters">
                                    <input type="date" id="filter-date-from" class="filter-input" placeholder="Du">
                                    <input type="date" id="filter-date-to" class="filter-input" placeholder="Au">
                                    <select id="filter-departement" class="filter-input">
                                        <option value="">Tous d√©partements</option>
                                    </select>
                                    <select id="filter-statut" class="filter-input">
                                        <option value="">Tous statuts</option>
                                    </select>
                                    <button id="filter-btn" class="btn btn-primary" style="padding: 8px 15px;">
                                        <i class="fas fa-filter"></i> Filtrer
                                    </button>
                                    <button id="export-btn" class="btn btn-success" style="padding: 8px 15px;">
                                        <i class="fas fa-file-excel"></i> Exporter
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-scroll-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>R√©f√©rence</th>
                                            <th>Type</th>
                                            <th>D√©partement</th>
                                            <th>Client</th>
                                            <th>Montant</th>
                                            <th>Motif</th>
                                            <th>Statut</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rejets-table-body">
                                        <!-- Les rejets seront ajout√©s ici dynamiquement -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Contr√¥les de pagination -->
                        <div class="pagination-controls">
                            <div class="pagination-info" id="pagination-info">
                                Affichage de 0 √† 0 sur 0 √©l√©ments
                            </div>
                            
                            <div class="pagination-buttons" id="pagination-buttons">
                                <!-- Les boutons de pagination seront g√©n√©r√©s dynamiquement -->
                            </div>
                            
                            <div class="rows-per-page">
                                <span>Afficher :</span>
                                <select id="rows-per-page-select" class="filter-input">
                                    <option value="10">10</option>
                                    <option value="25" selected>25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                                <span>lignes</span>
                            </div>
                        </div>
                    </div>

                    <!-- Validation Page (pour superviseur et gestionnaire) -->
                    <div id="validation-page" class="page-content" style="display: none;">
                        <h2 class="page-title">
                            <i class="fas fa-check-circle"></i> Validation des rejets
                        </h2>
                        
                        <div class="dashboard-cards">
                            <div class="card">
                                <h3>En attente de validation</h3>
                                <div class="value" id="pending-validation">0</div>
                                <div class="trend">√Ä traiter</div>
                            </div>
                            <div class="card">
                                <h3>Valid√©s aujourd'hui</h3>
                                <div class="value" id="validated-today">0</div>
                                <div class="trend">Par vous</div>
                            </div>
                            <div class="card">
                                <h3>Rejets transmis</h3>
                                <div class="value" id="transmitted-today">0</div>
                                <div class="trend">En attente gestionnaire</div>
                            </div>
                            <div class="card">
                                <h3>Temps moyen</h3>
                                <div class="value" id="avg-time">0h</div>
                                <div class="trend">Traitement</div>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <div class="table-header">
                                <h3 style="margin: 0;">Rejets en attente de traitement</h3>
                                <div class="filters">
                                    <select id="validation-filter-type" class="filter-input">
                                        <option value="tous">Tous les types</option>
                                        <option value="a_valider">√Ä valider (superviseur)</option>
                                        <option value="a_recevoir">√Ä recevoir (gestionnaire)</option>
                                    </select>
                                    <button id="refresh-validation" class="btn btn-primary" style="padding: 8px 15px;">
                                        <i class="fas fa-sync-alt"></i> Actualiser
                                    </button>
                                </div>
                            </div>
                            
                            <div style="overflow-x: auto;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>R√©f√©rence</th>
                                            <th>Agent OPS</th>
                                            <th>Client</th>
                                            <th>Montant</th>
                                            <th>Motif</th>
                                            <th>Date saisie</th>
                                            <th>√âtape actuelle</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="validation-table-body">
                                        <!-- Les rejets en attente seront ajout√©s ici -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Rapports d√©taill√©s Page -->
                    <div id="rapports-page" class="page-content" style="display: none;">
                        <h2 class="page-title">
                            <i class="fas fa-chart-bar"></i> Rapports d√©taill√©s
                            <div class="page-title-actions">
                                <button class="btn btn-success" id="generate-pdf">
                                    <i class="fas fa-file-pdf"></i> G√©n√©rer PDF
                                </button>
                            </div>
                        </h2>
                        
                        <div class="rapport-container" id="rapport-content">
                            <div class="rapport-header">
                                <h2>Rapport d√©taill√© des rejets</h2>
                                <p>Syst√®me de Gestion des Rejets - Banque</p>
                                <p id="rapport-period">P√©riode : Du [date] au [date]</p>
                            </div>
                            
                            <div class="rapport-period">
                                <div>
                                    <label for="rapport-date-from">Date de d√©but :</label>
                                    <input type="date" id="rapport-date-from" class="form-control" style="width: auto; display: inline-block;">
                                </div>
                                <div>
                                    <label for="rapport-date-to">Date de fin :</label>
                                    <input type="date" id="rapport-date-to" class="form-control" style="width: auto; display: inline-block;">
                                </div>
                                <div>
                                    <label for="rapport-type">Type de rapport :</label>
                                    <select id="rapport-type" class="form-control" style="width: auto; display: inline-block;">
                                        <option value="complet">Rapport complet</option>
                                        <option value="mensuel">Mensuel</option>
                                        <option value="hebdomadaire">Hebdomadaire</option>
                                        <option value="journalier">Journalier</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary" id="update-rapport">
                                    <i class="fas fa-sync-alt"></i> Actualiser
                                </button>
                            </div>
                            
                            <div class="rapport-statistiques">
                                <div class="rapport-stat">
                                    <h4>Total rejets</h4>
                                    <div class="value" id="rapport-total">0</div>
                                    <p>Sur la p√©riode</p>
                                </div>
                                <div class="rapport-stat">
                                    <h4>Montant total</h4>
                                    <div class="value" id="rapport-montant">0 MAD</div>
                                    <p>Valeur des rejets</p>
                                </div>
                                <div class="rapport-stat">
                                    <h4>Taux de validation</h4>
                                    <div class="value" id="rapport-taux">0%</div>
                                    <p>Rejets trait√©s</p>
                                </div>
                                <div class="rapport-stat">
                                    <h4>Top motif</h4>
                                    <div class="value" id="rapport-top-motif">-</div>
                                    <p>Motif le plus fr√©quent</p>
                                </div>
                            </div>
                            
                            <div class="charts-container">
                                <div class="chart-box">
                                    <h3 class="chart-title">
                                        <i class="fas fa-chart-line"></i> √âvolution des rejets
                                    </h3>
                                    <canvas id="evolutionChart"></canvas>
                                </div>
                                <div class="chart-box">
                                    <h3 class="chart-title">
                                        <i class="fas fa-chart-pie"></i> R√©partition par d√©partement
                                    </h3>
                                    <canvas id="rapportDepartementChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <div class="table-header">
                                    <h3 style="margin: 0;">D√©tails des rejets</h3>
                                </div>
                                <div style="overflow-x: auto;">
                                    <table id="rapport-table">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>R√©f√©rence</th>
                                                <th>Type</th>
                                                <th>D√©partement</th>
                                                <th>Client</th>
                                                <th>Montant</th>
                                                <th>Motif</th>
                                                <th>Agent</th>
                                                <th>Statut</th>
                                            </tr>
                                        </thead>
                                        <tbody id="rapport-table-body">
                                            <!-- Donn√©es du rapport -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="chart-box">
                                <h3 class="chart-title">
                                    <i class="fas fa-users"></i> Top 10 clients avec rejets r√©currents
                                </h3>
                                <div id="rapport-clients-list">
                                    <!-- Liste g√©n√©r√©e dynamiquement -->
                                </div>
                            </div>
                            
                            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                                <h4>Analyse et recommandations</h4>
                                <div id="rapport-analyse">
                                    <p>Analyse g√©n√©r√©e automatiquement bas√©e sur les donn√©es...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Administration Page -->
                    <div id="administration-page" class="page-content" style="display: none;">
                        <h2 class="page-title">
                            <i class="fas fa-cog"></i> Administration du syst√®me
                        </h2>
                        
                        <div class="tabs">
                            <div class="tab active" data-tab="users">Gestion des utilisateurs</div>
                            <div class="tab" data-tab="config">Configuration syst√®me</div>
                            <div class="tab" data-tab="options">Options de saisie</div>
                            <div class="tab" data-tab="logs">Journal d'activit√©</div>
                        </div>
                        
                        <!-- Gestion des utilisateurs -->
                        <div class="tab-content active" id="users-tab">
                            <div style="margin-bottom: 20px;">
                                <button class="btn btn-primary" id="add-user-btn">
                                    <i class="fas fa-user-plus"></i> Ajouter un utilisateur
                                </button>
                            </div>
                            
                            <div class="table-container">
                                <div class="table-header">
                                    <h3 style="margin: 0;">Liste des utilisateurs</h3>
                                    <div class="filters">
                                        <input type="text" id="search-user" class="filter-input" placeholder="Rechercher un utilisateur...">
                                        <select id="filter-user-role" class="filter-input">
                                            <option value="">Tous les r√¥les</option>
                                            <option value="agent">Agent OPS</option>
                                            <option value="superviseur">Superviseur</option>
                                            <option value="gestionnaire">Gestionnaire</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div style="overflow-x: auto;">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Nom d'utilisateur</th>
                                                <th>Nom complet</th>
                                                <th>R√¥le</th>
                                                <th>Email</th>
                                                <th>D√©partement</th>
                                                <th>Date cr√©ation</th>
                                                <th>Statut</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="users-table-body">
                                            <!-- Liste des utilisateurs -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Configuration syst√®me -->
                        <div class="tab-content" id="config-tab">
                            <div class="config-grid">
                                <div class="config-card">
                                    <h4><i class="fas fa-shield-alt"></i> S√©curit√©</h4>
                                    <div class="config-item">
                                        <span>Authentification √† deux facteurs</span>
                                        <label class="switch">
                                            <input type="checkbox" id="config-2fa" data-config="security.2fa">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    <div class="config-item">
                                        <span>Expiration session (minutes)</span>
                                        <input type="number" id="config-session" class="form-control" style="width: 80px;" data-config="security.session_timeout" value="30">
                                    </div>
                                    <div class="config-item">
                                        <span>Nombre max de tentatives</span>
                                        <input type="number" id="config-max-attempts" class="form-control" style="width: 80px;" data-config="security.max_login_attempts" value="3">
                                    </div>
                                </div>
                                
                                <div class="config-card">
                                    <h4><i class="fas fa-bell"></i> Notifications</h4>
                                    <div class="config-item">
                                        <span>Notifications email</span>
                                        <label class="switch">
                                            <input type="checkbox" id="config-email-notif" data-config="notifications.email" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    <div class="config-item">
                                        <span>Alertes superviseur</span>
                                        <label class="switch">
                                            <input type="checkbox" id="config-supervisor-alerts" data-config="notifications.supervisor_alerts" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    <div class="config-item">
                                        <span>Rapports automatiques</span>
                                        <select id="config-auto-reports" class="form-control" style="width: 150px;" data-config="notifications.auto_reports">
                                            <option value="daily">Quotidien</option>
                                            <option value="weekly">Hebdomadaire</option>
                                            <option value="monthly">Mensuel</option>
                                            <option value="none">Aucun</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="config-card">
                                    <h4><i class="fas fa-chart-line"></i> Rapports</h4>
                                    <div class="config-item">
                                        <span>Conservation donn√©es (jours)</span>
                                        <input type="number" id="config-data-retention" class="form-control" style="width: 100px;" data-config="reports.data_retention" value="365">
                                    </div>
                                    <div class="config-item">
                                        <span>Format PDF par d√©faut</span>
                                        <select id="config-pdf-format" class="form-control" style="width: 150px;" data-config="reports.default_pdf_format">
                                            <option value="A4">A4</option>
                                            <option value="Letter">Letter</option>
                                        </select>
                                    </div>
                                    <div class="config-item">
                                        <span>Inclure graphiques</span>
                                        <label class="switch">
                                            <input type="checkbox" id="config-include-charts" data-config="reports.include_charts" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="config-card">
                                    <h4><i class="fas fa-cogs"></i> Syst√®me</h4>
                                    <div class="config-item">
                                        <span>Mode maintenance</span>
                                        <label class="switch">
                                            <input type="checkbox" id="config-maintenance" data-config="system.maintenance_mode">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    <div class="config-item">
                                        <span>Langue par d√©faut</span>
                                        <select id="config-default-language" class="form-control" style="width: 150px;" data-config="system.default_language">
                                            <option value="fr">Fran√ßais</option>
                                            <option value="en">English</option>
                                        </select>
                                    </div>
                                    <div class="config-item">
                                        <span>Sauvegarde automatique</span>
                                        <label class="switch">
                                            <input type="checkbox" id="config-auto-backup" data-config="system.auto_backup" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button class="btn btn-secondary" id="reset-config">
                                    <i class="fas fa-undo"></i> R√©initialiser
                                </button>
                                <button class="btn btn-primary" id="save-config">
                                    <i class="fas fa-save"></i> Sauvegarder
                                </button>
                            </div>
                        </div>
                        
                        <!-- Options de saisie -->
                        <div class="tab-content" id="options-tab">
                            <div class="config-grid">
                                <div class="config-card">
                                    <h4><i class="fas fa-file-alt"></i> Types de pi√®ces</h4>
                                    <div id="piece-types-list">
                                        <!-- Liste des types de pi√®ces -->
                                    </div>
                                    <div style="margin-top: 15px;">
                                        <button class="btn btn-secondary" onclick="addConfigItem('piece')">
                                            <i class="fas fa-plus"></i> Ajouter un type
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="config-card">
                                    <h4><i class="fas fa-building"></i> D√©partements</h4>
                                    <div id="departements-list">
                                        <!-- Liste des d√©partements -->
                                    </div>
                                    <div style="margin-top: 15px;">
                                        <button class="btn btn-secondary" onclick="addConfigItem('departement')">
                                            <i class="fas fa-plus"></i> Ajouter un d√©partement
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="config-card">
                                    <h4><i class="fas fa-exclamation-circle"></i> Motifs de rejet</h4>
                                    <div id="motifs-list">
                                        <!-- Liste des motifs -->
                                    </div>
                                    <div style="margin-top: 15px;">
                                        <button class="btn btn-secondary" onclick="addConfigItem('motif')">
                                            <i class="fas fa-plus"></i> Ajouter un motif
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="config-card">
                                    <h4><i class="fas fa-user-tie"></i> Charg√©s √† notifier</h4>
                                    <div id="charges-list">
                                        <!-- Liste des charg√©s -->
                                    </div>
                                    <div style="margin-top: 15px;">
                                        <button class="btn btn-secondary" onclick="addConfigItem('charge')">
                                            <i class="fas fa-plus"></i> Ajouter un charg√©
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="config-card" style="margin-top: 20px;">
                                <h4><i class="fas fa-plus-square"></i> Champs suppl√©mentaires</h4>
                                <div id="additional-fields-config">
                                    <!-- Configuration des champs suppl√©mentaires -->
                                </div>
                                <div style="margin-top: 15px;">
                                    <button class="btn btn-secondary" onclick="addAdditionalField()">
                                        <i class="fas fa-plus"></i> Ajouter un champ
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Journal d'activit√© -->
                        <div class="tab-content" id="logs-tab">
                            <div class="table-container">
                                <div class="table-header">
                                    <h3 style="margin: 0;">Journal d'activit√© syst√®me</h3>
                                    <div class="filters">
                                        <input type="date" id="log-date-from" class="filter-input">
                                        <input type="date" id="log-date-to" class="filter-input">
                                        <select id="log-level" class="filter-input">
                                            <option value="">Tous les niveaux</option>
                                            <option value="info">Info</option>
                                            <option value="warning">Avertissement</option>
                                            <option value="error">Erreur</option>
                                            <option value="security">S√©curit√©</option>
                                        </select>
                                        <button class="btn btn-primary" id="filter-logs">
                                            <i class="fas fa-filter"></i> Filtrer
                                        </button>
                                        <button class="btn btn-secondary" id="export-logs">
                                            <i class="fas fa-download"></i> Exporter
                                        </button>
                                    </div>
                                </div>
                                
                                <div style="overflow-x: auto;">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Date/Heure</th>
                                                <th>Niveau</th>
                                                <th>Utilisateur</th>
                                                <th>Action</th>
                                                <th>D√©tails</th>
                                                <th>IP</th>
                                            </tr>
                                        </thead>
                                        <tbody id="logs-table-body">
                                            <!-- Journal d'activit√© -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Modal pour ajouter/modifier utilisateur -->
    <div id="user-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-user-title">Ajouter un utilisateur</h3>
                <button class="btn-icon" onclick="closeModal('user-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="user-form">
                    <input type="hidden" id="modal-user-id">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="modal-username">Nom d'utilisateur *</label>
                            <input type="text" id="modal-username" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="modal-fullname">Nom complet *</label>
                            <input type="text" id="modal-fullname" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="modal-password">Mot de passe *</label>
                            <input type="password" id="modal-password" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="modal-confirm-password">Confirmer le mot de passe *</label>
                            <input type="password" id="modal-confirm-password" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="modal-email">Email *</label>
                            <input type="email" id="modal-email" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="modal-role">R√¥le *</label>
                            <select id="modal-role" class="form-control" required>
                                <option value="agent">Agent OPS</option>
                                <option value="superviseur">Superviseur</option>
                                <option value="gestionnaire">Gestionnaire</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="modal-departement">D√©partement</label>
                            <select id="modal-departement" class="form-control">
                                <option value="">S√©lectionnez...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="modal-status">Statut</label>
                            <select id="modal-status" class="form-control">
                                <option value="active">Actif</option>
                                <option value="inactive">Inactif</option>
                                <option value="suspended">Suspendu</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="modal-permissions">Permissions suppl√©mentaires</label>
                            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="permission-export" value="export">
                                    <span>Export des donn√©es</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="permission-reports" value="reports">
                                    <span>G√©n√©ration de rapports</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="permission-view-all" value="view_all">
                                    <span>Voir tous les rejets</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('user-modal')">Annuler</button>
                <button class="btn btn-primary" id="save-user-btn">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Modal pour changer le mot de passe (page de connexion) -->
    <div id="change-password-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3>Changer mon mot de passe</h3>
                <button class="btn-icon" onclick="closeModal('change-password-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="change-password-form">
                    <div class="form-group">
                        <label for="change-password-email">Email</label>
                        <input type="email" id="change-password-email" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="change-password-current">Mot de passe actuel</label>
                        <input type="password" id="change-password-current" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="change-password-new">Nouveau mot de passe</label>
                        <input type="password" id="change-password-new" class="form-control" required>
                        <small style="color: #666;">Le mot de passe doit contenir au moins 6 caract√®res</small>
                    </div>
                    <div class="form-group">
                        <label for="change-password-confirm">Confirmer le nouveau mot de passe</label>
                        <input type="password" id="change-password-confirm" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('change-password-modal')">Annuler</button>
                <button class="btn btn-primary" id="save-change-password-btn">Changer le mot de passe</button>
            </div>
        </div>
    </div>

    <!-- Modal pour r√©initialiser le mot de passe (admin) -->
    <div id="reset-password-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3>R√©initialiser le mot de passe</h3>
                <button class="btn-icon" onclick="closeModal('reset-password-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="reset-password-form">
                    <input type="hidden" id="reset-password-user-id">
                    <div class="form-group">
                        <label for="reset-password-username">Utilisateur</label>
                        <input type="text" id="reset-password-username" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="reset-password-fullname">Nom complet</label>
                        <input type="text" id="reset-password-fullname" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="reset-password-new">Nouveau mot de passe</label>
                        <input type="password" id="reset-password-new" class="form-control" required>
                        <small style="color: #666;">Le mot de passe doit contenir au moins 6 caract√®res</small>
                    </div>
                    <div class="form-group">
                        <label for="reset-password-confirm">Confirmer le nouveau mot de passe</label>
                        <input type="password" id="reset-password-confirm" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="reset-password-force-change">
                            Forcer l'utilisateur √† changer le mot de passe √† la prochaine connexion
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('reset-password-modal')">Annuler</button>
                <button class="btn btn-primary" id="save-reset-password-btn">R√©initialiser le mot de passe</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // INITIALISATION SUPABASE
        // ============================================
        
        // Configuration Supabase avec vos informations
        const supabaseUrl = 'https://qldfjdmpzvyhgsmepynp.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFsZGZqZG1wenZ5aGdzbWVweW5wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0OTU3NTEsImV4cCI6MjA4NDA3MTc1MX0.xAm9RrmzMCuxMfu4xjygPZMyiNbJqSXH9L_GNegbiBI';
        
        // Initialisation de Supabase (UNE SEULE D√âCLARATION)
        let supabase;
        try {
            supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
            console.log('Supabase initialis√© avec succ√®s');
        } catch (error) {
            console.error('Erreur lors de l\'initialisation de Supabase:', error);
            // En cas d'erreur, on utilise un syst√®me local
            alert('Supabase non disponible, utilisation du mode local');
        }

        // ============================================
        // DONN√âES ET INITIALISATION
        // ============================================
        
        // Donn√©es de d√©monstration avec workflow complet
        let rejetsData = JSON.parse(localStorage.getItem('rejetsData')) || [
            {
                id: 1,
                reference: 'REJ-OV-2023-001',
                type: 'OV',
                departement: 'corporate',
                charge: 'amine.rachidi',
                clientNom: 'SARL ALPHA TECH',
                clientCompte: '0123456789',
                montant: 125000.50,
                date: '2023-10-15',
                motif: 'provision_insuffisante',
                commentaire: 'Solde insuffisant pour ex√©cution',
                agent: 'agent1',
                dateSaisie: '2023-10-15',
                statut: 'valide',
                historique: [
                    { action: 'enregistre', user: 'agent1', date: '2023-10-15 09:30', role: 'agent' },
                    { action: 'valide', user: 'superviseur1', date: '2023-10-15 14:15', role: 'superviseur' },
                    { action: 'transmis', user: 'superviseur1', date: '2023-10-15 14:20', role: 'superviseur' },
                    { action: 'recu', user: 'gestionnaire1', date: '2023-10-16 10:00', role: 'gestionnaire' }
                ]
            },
            {
                id: 2,
                reference: 'REJ-RC-2023-002',
                type: 'RC',
                departement: 'sme',
                charge: 'fatima.zahra',
                clientNom: 'EURL BETA SERVICES',
                clientCompte: '9876543210',
                montant: 8500.00,
                date: '2023-10-16',
                motif: 'signature_non_conforme',
                commentaire: 'Signature ne correspond pas √† la fiche',
                agent: 'agent2',
                dateSaisie: '2023-10-16',
                statut: 'attente_validation',
                historique: [
                    { action: 'enregistre', user: 'agent2', date: '2023-10-16 11:45', role: 'agent' }
                ]
            },
            {
                id: 3,
                reference: 'REJ-OV-2023-003',
                type: 'OV',
                departement: 'vip',
                charge: 'karim.alami',
                clientNom: 'M. MOHAMED KARIM',
                clientCompte: '4561237890',
                montant: 25000.00,
                date: '2023-10-17',
                motif: 'rib_errone',
                commentaire: 'RIB incorrect - banque non trouv√©e',
                agent: 'agent1',
                dateSaisie: '2023-10-17',
                statut: 'transmis',
                historique: [
                    { action: 'enregistre', user: 'agent1', date: '2023-10-17 10:20', role: 'agent' },
                    { action: 'valide', user: 'superviseur1', date: '2023-10-17 15:30', role: 'superviseur' },
                    { action: 'transmis', user: 'superviseur1', date: '2023-10-17 15:35', role: 'superviseur' }
                ]
            }
        ];

        // Configuration syst√®me
        let systemConfig = JSON.parse(localStorage.getItem('systemConfig')) || {
            security: {
                '2fa': false,
                session_timeout: 30,
                max_login_attempts: 3
            },
            notifications: {
                email: true,
                supervisor_alerts: true,
                auto_reports: 'weekly'
            },
            reports: {
                data_retention: 365,
                default_pdf_format: 'A4',
                include_charts: true
            },
            system: {
                maintenance_mode: false,
                default_language: 'fr',
                auto_backup: true
            }
        };

        // Gestion des utilisateurs
        let usersData = JSON.parse(localStorage.getItem('usersData')) || [
            {
                id: 1,
                username: 'agent1',
                fullname: 'Agent OPS 1',
                password: 'agent123',
                email: 'agent1@banque.demo',
                role: 'agent',
                departement: 'corporate',
                status: 'active',
                permissions: [],
                created_at: '2023-01-15',
                force_password_change: false
            },
            {
                id: 2,
                username: 'superviseur1',
                fullname: 'Superviseur Admin',
                password: 'super123',
                email: 'superviseur@banque.demo',
                role: 'superviseur',
                departement: 'administration',
                status: 'active',
                permissions: ['export', 'reports', 'view_all'],
                created_at: '2023-01-10',
                force_password_change: false
            },
            {
                id: 3,
                username: 'gestionnaire1',
                fullname: 'Gestionnaire Comptes',
                password: 'gest123',
                email: 'gestionnaire@banque.demo',
                role: 'gestionnaire',
                departement: 'comptabilit√©',
                status: 'active',
                permissions: ['export'],
                created_at: '2023-01-12',
                force_password_change: false
            },
            // Ajout de votre compte pour la d√©mo
            {
                id: 100,
                username: 'sramadan',
                fullname: 'Souma√Øla Ramadan',
                password: 'sramadan123', // Mot de passe pour la d√©mo
                email: 'sramadan@ecobank.com',
                role: 'superviseur',
                departement: 'corporate',
                status: 'active',
                permissions: ['export', 'reports', 'view_all'],
                created_at: '2023-10-01',
                force_password_change: false
            }
        ];

        // Configuration des options de saisie
        let saisieConfig = JSON.parse(localStorage.getItem('saisieConfig')) || {
            types_pieces: ['OV', 'RC', 'PC'],
            departements: ['Corporate', 'SME (PME)', 'Juridique', 'FINCON', 'RISK', 'Agence VIP', 'Autres agences', 'Operation'],
            motifs: [
                'Provision insuffisante',
                'Signature non conforme',
                'Signature rat√©e',
                'Discordance montant (lettre/chiffre)',
                'Discordance intitul√©/num√©ro compte',
                'Compte invalide',
                'RIB erron√©',
                'Compte sous restriction',
                'Opposition'
            ],
            charges: [
                { id: 'MHT.NR', nom: 'MHT NOUR', departement: 'corporate' },
                { id: 'ham.Abou', nom: 'ABOUBAKARY', departement: 'sme' },
                { id: 'bienv', nom: 'BIENVENUE', departement: 'vip' },
                { id: 'SAM', nom: 'SAMUEL', departement: 'fincon' }
            ],
            champs_supplementaires: [
                {
                    id: 'urgence',
                    label: 'Niveau d\'urgence',
                    type: 'select',
                    options: ['Normal', '√âlev√©', 'Critique'],
                    required: false
                },
                {
                    id: 'document_ref',
                    label: 'R√©f√©rence document',
                    type: 'text',
                    required: false
                }
            ]
        };

        // Journal d'activit√©
        let activityLogs = JSON.parse(localStorage.getItem('activityLogs')) || [
            {
                id: 1,
                timestamp: '2023-10-15 09:30:00',
                level: 'info',
                user: 'agent1',
                action: 'Connexion',
                details: 'Connexion r√©ussie',
                ip: '192.168.1.100'
            },
            {
                id: 2,
                timestamp: '2023-10-15 09:35:00',
                level: 'info',
                user: 'agent1',
                action: 'Cr√©ation rejet',
                details: 'Rejet REJ-OV-2023-001 cr√©√©',
                ip: '192.168.1.100'
            },
            {
                id: 3,
                timestamp: '2023-10-15 14:15:00',
                level: 'info',
                user: 'superviseur1',
                action: 'Validation rejet',
                details: 'Rejet REJ-OV-2023-001 valid√©',
                ip: '192.168.1.101'
            }
        ];

        // √âtat de l'application
        let currentUser = null;
        let currentLanguage = 'fr';
        let currentPage = 'dashboard';

        // Variables pour la pagination
        let currentPageRejets = 1;
        let rowsPerPage = 25;
        let filteredRejetsList = [];

        // ============================================
        // FONCTIONS UTILITAIRES
        // ============================================
        
        function saveAllData() {
            localStorage.setItem('rejetsData', JSON.stringify(rejetsData));
            localStorage.setItem('systemConfig', JSON.stringify(systemConfig));
            localStorage.setItem('usersData', JSON.stringify(usersData));
            localStorage.setItem('saisieConfig', JSON.stringify(saisieConfig));
            localStorage.setItem('activityLogs', JSON.stringify(activityLogs));
        }

        function addLog(level, action, details) {
            const log = {
                id: activityLogs.length > 0 ? Math.max(...activityLogs.map(l => l.id)) + 1 : 1,
                timestamp: new Date().toISOString().replace('T', ' ').substring(0, 19),
                level: level,
                user: currentUser ? currentUser.username : 'system',
                action: action,
                details: details,
                ip: '127.0.0.1' // Dans une vraie app, on r√©cup√©rerait l'IP r√©elle
            };
            activityLogs.push(log);
            saveAllData();
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR');
        }

        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            return date.toLocaleString('fr-FR');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-FR', { 
                style: 'currency', 
                currency: 'XAF',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function generateReference(type) {
            const prefix = type === 'OV' ? 'REJ-OV' : type === 'RC' ? 'REJ-RC' : 'REJ-PC';
            const year = new Date().getFullYear();
            const count = rejetsData.filter(r => r.reference.startsWith(prefix)).length + 1;
            return `${prefix}-${year}-${count.toString().padStart(3, '0')}`;
        }

        function getMotifText(code) {
            // Chercher dans les motifs configur√©s
            const motif = saisieConfig.motifs.find(m => 
                m.toLowerCase().replace(/[^a-z0-9]/g, '_') === code
            );
            return motif || code;
        }

        function getDepartementText(code) {
            // Chercher dans les d√©partements configur√©s
            const dept = saisieConfig.departements.find(d => 
                d.toLowerCase().replace(/[^a-z0-9]/g, '_') === code
            );
            return dept || code;
        }

        function getStatutText(code) {
            const mapping = {
                'enregistre': { text: 'Enregistr√©', class: 'status-enregistre' },
                'attente_validation': { text: 'Attente validation', class: 'status-attente-validation' },
                'valide': { text: 'Valid√©', class: 'status-valide' },
                'transmis': { text: 'Transmis', class: 'status-transmis' },
                'recu': { text: 'Re√ßu', class: 'status-recu' }
            };
            return mapping[code] || { text: code, class: '' };
        }

        function getNextAction(statut, role) {
            if (role === 'superviseur') {
                if (statut === 'attente_validation') return 'Valider';
                if (statut === 'valide') return 'Transmettre';
            }
            if (role === 'gestionnaire' && statut === 'transmis') return 'Confirmer r√©ception';
            return null;
        }

        // ============================================
        // FONCTIONS POUR CHANGEMENT MOT DE PASSE
        // ============================================

        // Fonction pour ouvrir le modal de changement de mot de passe
        function openChangePasswordModal() {
            // Pr√©-remplir l'email avec la valeur du champ de connexion
            const loginEmail = document.getElementById('loginEmail').value;
            document.getElementById('change-password-email').value = loginEmail;
            
            // R√©initialiser le formulaire
            document.getElementById('change-password-form').reset();
            document.getElementById('change-password-email').value = loginEmail;
            
            // Afficher le modal
            showModal('change-password-modal');
        }

        // Fonction pour changer le mot de passe
        function changePassword() {
            const email = document.getElementById('change-password-email').value;
            const currentPassword = document.getElementById('change-password-current').value;
            const newPassword = document.getElementById('change-password-new').value;
            const confirmPassword = document.getElementById('change-password-confirm').value;

            // Validation
            if (!email || !currentPassword || !newPassword || !confirmPassword) {
                alert('Veuillez remplir tous les champs.');
                return;
            }

            if (newPassword.length < 6) {
                alert('Le nouveau mot de passe doit contenir au moins 6 caract√®res.');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('Les nouveaux mots de passe ne correspondent pas.');
                return;
            }

            // Trouver l'utilisateur
            const userIndex = usersData.findIndex(u => u.email === email);
            
            if (userIndex === -1) {
                alert('Utilisateur non trouv√©.');
                return;
            }

            // V√©rifier le mot de passe actuel
            if (usersData[userIndex].password !== currentPassword) {
                alert('Mot de passe actuel incorrect.');
                return;
            }

            // Changer le mot de passe
            usersData[userIndex].password = newPassword;
            usersData[userIndex].force_password_change = false;
            
            // Sauvegarder les donn√©es
            saveAllData();
            
            // Ajouter un log
            addLog('security', 'Changement mot de passe', 
                  `Utilisateur ${usersData[userIndex].username} a chang√© son mot de passe`);
            
            // Fermer le modal
            closeModal('change-password-modal');
            
            // Afficher un message de succ√®s
            alert('Mot de passe chang√© avec succ√®s ! Vous pouvez maintenant vous connecter avec votre nouveau mot de passe.');
        }

        // Fonction pour ouvrir le modal de r√©initialisation de mot de passe (admin)
        function openResetPasswordModal(userId) {
            const user = usersData.find(u => u.id === userId);
            
            if (!user) {
                alert('Utilisateur non trouv√©.');
                return;
            }

            // Remplir les informations
            document.getElementById('reset-password-user-id').value = user.id;
            document.getElementById('reset-password-username').value = user.username;
            document.getElementById('reset-password-fullname').value = user.fullname;
            
            // R√©initialiser le formulaire
            document.getElementById('reset-password-form').reset();
            document.getElementById('reset-password-force-change').checked = true;
            
            // Afficher le modal
            showModal('reset-password-modal');
        }

        // Fonction pour r√©initialiser le mot de passe (admin)
        function resetPassword() {
            const userId = parseInt(document.getElementById('reset-password-user-id').value);
            const newPassword = document.getElementById('reset-password-new').value;
            const confirmPassword = document.getElementById('reset-password-confirm').value;
            const forceChange = document.getElementById('reset-password-force-change').checked;

            // Validation
            if (!newPassword || !confirmPassword) {
                alert('Veuillez remplir tous les champs.');
                return;
            }

            if (newPassword.length < 6) {
                alert('Le nouveau mot de passe doit contenir au moins 6 caract√®res.');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('Les mots de passe ne correspondent pas.');
                return;
            }

            // Trouver l'utilisateur
            const userIndex = usersData.findIndex(u => u.id === userId);
            
            if (userIndex === -1) {
                alert('Utilisateur non trouv√©.');
                return;
            }

            // R√©initialiser le mot de passe
            usersData[userIndex].password = newPassword;
            usersData[userIndex].force_password_change = forceChange;
            
            // Sauvegarder les donn√©es
            saveAllData();
            
            // Ajouter un log
            addLog('security', 'R√©initialisation mot de passe', 
                  `Admin ${currentUser.username} a r√©initialis√© le mot de passe de ${usersData[userIndex].username}`);
            
            // Fermer le modal
            closeModal('reset-password-modal');
            
            // Afficher un message de succ√®s
            alert(`Mot de passe r√©initialis√© avec succ√®s pour ${usersData[userIndex].username} !
${forceChange ? 'L\'utilisateur devra changer son mot de passe √† la prochaine connexion.' : ''}`);
        }

        // ============================================
        // FONCTIONS D'AFFICHAGE
        // ============================================
        
        function showPage(pageId) {
            // Cacher toutes les pages
            document.querySelectorAll('.page-content').forEach(page => {
                page.style.display = 'none';
            });
            
            // Afficher la page demand√©e
            document.getElementById(`${pageId}-page`).style.display = 'block';
            
            // Mettre √† jour la navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-page') === pageId) {
                    item.classList.add('active');
                }
            });
            
            // Mettre √† jour le contenu selon la page
            switch(pageId) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'saisie':
                    loadSaisieForm();
                    break;
                case 'rejets':
                    loadRejetsTable();
                    break;
                case 'validation':
                    loadValidationTable();
                    break;
                case 'rapports':
                    loadRapports();
                    break;
                case 'administration':
                    if (currentUser.role === 'superviseur') {
                        loadAdministration();
                    } else {
                        showPage('dashboard');
                        alert('Acc√®s non autoris√©');
                    }
                    break;
            }
            
            currentPage = pageId;
        }

        function updateDashboard() {
            // Calculer les statistiques
            const today = new Date().toISOString().split('T')[0];
            const rejetsToday = rejetsData.filter(r => r.dateSaisie === today).length;
            const rejetsMonth = rejetsData.filter(r => {
                const date = new Date(r.dateSaisie);
                const now = new Date();
                return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
            }).length;
            
            // Calculer les rejets √† valider selon le r√¥le
            let aValider = 0;
            if (currentUser.role === 'superviseur') {
                aValider = rejetsData.filter(r => r.statut === 'attente_validation' || r.statut === 'valide').length;
            } else if (currentUser.role === 'gestionnaire') {
                aValider = rejetsData.filter(r => r.statut === 'transmis').length;
            }
            
            // Calculer le taux de validation
            const totalValides = rejetsData.filter(r => r.statut === 'valide' || r.statut === 'transmis' || r.statut === 'recu').length;
            const tauxValidation = rejetsData.length > 0 ? Math.round((totalValides / rejetsData.length) * 100) : 0;
            
            // Mettre √† jour les cartes
            document.getElementById('rejets-today').textContent = rejetsToday;
            document.getElementById('rejets-month').textContent = rejetsMonth;
            document.getElementById('a-valider').textContent = aValider;
            document.getElementById('taux-validation').textContent = tauxValidation + '%';
            
            // Texte selon le r√¥le
            const trendText = currentUser.role === 'superviseur' ? 'Attente superviseur' : 
                             currentUser.role === 'gestionnaire' ? 'Attente gestionnaire' : 
                             'En cours de traitement';
            document.getElementById('a-valider-trend').textContent = trendText;
            
            // Mettre √† jour les graphiques
            updateCharts();
            updateTopClients();
        }

        function updateCharts() {
            // Graphique par statut
            const statutCounts = {
                enregistre: 0,
                attente_validation: 0,
                valide: 0,
                transmis: 0,
                recu: 0
            };
            
            rejetsData.forEach(r => {
                statutCounts[r.statut] = (statutCounts[r.statut] || 0) + 1;
            });
            
            const statutLabels = ['Enregistr√©', 'Attente validation', 'Valid√©', 'Transmis', 'Re√ßu'];
            const statutData = [
                statutCounts.enregistre,
                statutCounts.attente_validation,
                statutCounts.valide,
                statutCounts.transmis,
                statutCounts.recu
            ];
            
            // Supprimer l'ancien graphique s'il existe
            const statutCanvas = document.getElementById('statutChart');
            const statutCtx = statutCanvas.getContext('2d');
            if (window.statutChartInstance) {
                window.statutChartInstance.destroy();
            }
            
            window.statutChartInstance = new Chart(statutCtx, {
                type: 'doughnut',
                data: {
                    labels: statutLabels,
                    datasets: [{
                        data: statutData,
                        backgroundColor: [
                            '#2196f3', // Enregistr√© - bleu
                            '#ff9800', // Attente validation - orange
                            '#4caf50', // Valid√© - vert
                            '#9c27b0', // Transmis - violet
                            '#2e7d32'  // Re√ßu - vert fonc√©
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
            
            // Graphique par d√©partement
            const deptCounts = {};
            rejetsData.forEach(r => {
                deptCounts[r.departement] = (deptCounts[r.departement] || 0) + 1;
            });
            
            const deptLabels = Object.keys(deptCounts).map(getDepartementText);
            const deptData = Object.values(deptCounts);
            
            // Supprimer l'ancien graphique s'il existe
            const deptCanvas = document.getElementById('departementChart');
            const deptCtx = deptCanvas.getContext('2d');
            if (window.deptChartInstance) {
                window.deptChartInstance.destroy();
            }
            
            window.deptChartInstance = new Chart(deptCtx, {
                type: 'bar',
                data: {
                    labels: deptLabels,
                    datasets: [{
                        label: 'Nombre de rejets',
                        data: deptData,
                        backgroundColor: '#3f51b5',
                        borderColor: '#303f9f',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function updateTopClients() {
            // Compter les rejets par client
            const clientCounts = {};
            rejetsData.forEach(r => {
                if (r.clientNom) {
                    clientCounts[r.clientNom] = (clientCounts[r.clientNom] || 0) + 1;
                }
            });
            
            // Trier par nombre de rejets
            const topClients = Object.entries(clientCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const container = document.getElementById('top-clients-list');
            if (topClients.length === 0) {
                container.innerHTML = '<p>Aucune donn√©e disponible. Saisissez des rejets pour voir les statistiques.</p>';
            } else {
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">';
                topClients.forEach(([client, count]) => {
                    html += `
                        <div style="background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="font-weight: 600; margin-bottom: 5px;">${client}</div>
                            <div style="color: #f44336; font-size: 1.5rem; font-weight: 700;">${count}</div>
                            <div style="font-size: 0.9rem; color: #666;">rejets</div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            }
        }

        function loadSaisieForm() {
            // Charger les types de pi√®ces
            const typePieceSelect = document.getElementById('type-piece');
            typePieceSelect.innerHTML = '<option value="">S√©lectionnez...</option>';
            saisieConfig.types_pieces.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type === 'OV' ? 'Ordre de Virement (OV)' : 
                                  type === 'RC' ? 'Remise de Ch√®que (R/C)' : 
                                  type === 'PC' ? 'Pi√®ce Comptable' : type;
                typePieceSelect.appendChild(option);
            });
            
            // Charger les d√©partements
            const departementSelect = document.getElementById('departement');
            departementSelect.innerHTML = '<option value="">S√©lectionnez...</option>';
            saisieConfig.departements.forEach(dept => {
                const option = document.createElement('option');
                const value = dept.toLowerCase().replace(/[^a-z0-9]/g, '_');
                option.value = value;
                option.textContent = dept;
                departementSelect.appendChild(option);
            });
            
            // Charger les motifs
            const motifSelect = document.getElementById('motif');
            motifSelect.innerHTML = '<option value="">S√©lectionnez...</option>';
            saisieConfig.motifs.forEach(motif => {
                const option = document.createElement('option');
                const value = motif.toLowerCase().replace(/[^a-z0-9]/g, '_');
                option.value = value;
                option.textContent = motif;
                motifSelect.appendChild(option);
            });
            
            // Charger les charg√©s
            const chargeSelect = document.getElementById('charge');
            chargeSelect.innerHTML = '<option value="">S√©lectionnez...</option>';
            saisieConfig.charges.forEach(charge => {
                const option = document.createElement('option');
                option.value = charge.id;
                option.textContent = charge.nom;
                chargeSelect.appendChild(option);
            });
            
            // Charger les champs suppl√©mentaires
            const additionalFields = document.getElementById('additional-fields');
            additionalFields.innerHTML = '';
            saisieConfig.champs_supplementaires.forEach(champ => {
                const fieldHTML = createFieldHTML(champ);
                additionalFields.insertAdjacentHTML('beforeend', fieldHTML);
            });
            
            // Mettre √† jour l'agent courant
            document.getElementById('current-agent').textContent = currentUser.fullname;
        }

        function createFieldHTML(champ) {
            let fieldHTML = '';
            switch(champ.type) {
                case 'select':
                    fieldHTML = `
                        <div class="form-row">
                            <div class="form-group">
                                <label for="field-${champ.id}">${champ.label} ${champ.required ? '*' : ''}</label>
                                <select id="field-${champ.id}" class="form-control" ${champ.required ? 'required' : ''}>
                                    <option value="">S√©lectionnez...</option>
                                    ${champ.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                    `;
                    break;
                case 'text':
                case 'number':
                case 'date':
                    fieldHTML = `
                        <div class="form-row">
                            <div class="form-group">
                                <label for="field-${champ.id}">${champ.label} ${champ.required ? '*' : ''}</label>
                                <input type="${champ.type}" id="field-${champ.id}" class="form-control" ${champ.required ? 'required' : ''}>
                            </div>
                        </div>
                    `;
                    break;
                case 'textarea':
                    fieldHTML = `
                        <div class="form-row">
                            <div class="form-group">
                                <label for="field-${champ.id}">${champ.label} ${champ.required ? '*' : ''}</label>
                                <textarea id="field-${champ.id}" class="form-control" rows="2" ${champ.required ? 'required' : ''}></textarea>
                            </div>
                        </div>
                    `;
                    break;
            }
            return fieldHTML;
        }

        function loadRejetsTable() {
            const tbody = document.getElementById('rejets-table-body');
            tbody.innerHTML = '';
            
            // Charger les options de filtres
            loadFilterOptions();
            
            // Appliquer les filtres
            const dateFrom = document.getElementById('filter-date-from').value;
            const dateTo = document.getElementById('filter-date-to').value;
            const deptFilter = document.getElementById('filter-departement').value;
            const statutFilter = document.getElementById('filter-statut').value;
            
            filteredRejetsList = rejetsData;
            
            if (dateFrom) {
                filteredRejetsList = filteredRejetsList.filter(r => r.dateSaisie >= dateFrom);
            }
            if (dateTo) {
                filteredRejetsList = filteredRejetsList.filter(r => r.dateSaisie <= dateTo);
            }
            if (deptFilter) {
                filteredRejetsList = filteredRejetsList.filter(r => r.departement === deptFilter);
            }
            if (statutFilter) {
                filteredRejetsList = filteredRejetsList.filter(r => r.statut === statutFilter);
            }
            
            // Filtrer selon le r√¥le et les permissions
            if (currentUser.role === 'agent' && !currentUser.permissions.includes('view_all')) {
                filteredRejetsList = filteredRejetsList.filter(r => r.agent === currentUser.username);
            }
            
            // Trier par date (plus r√©cent d'abord)
            filteredRejetsList.sort((a, b) => new Date(b.dateSaisie) - new Date(a.dateSaisie));
            
            // Mettre √† jour la pagination
            updatePagination();
        }

        function updatePagination() {
            const tbody = document.getElementById('rejets-table-body');
            tbody.innerHTML = '';
            
            const totalItems = filteredRejetsList.length;
            const totalPages = Math.ceil(totalItems / rowsPerPage);
            
            // Ajuster la page courante si n√©cessaire
            if (currentPageRejets > totalPages && totalPages > 0) {
                currentPageRejets = totalPages;
            } else if (totalPages === 0) {
                currentPageRejets = 1;
            }
            
            // Calculer les indices de d√©but et fin
            const startIndex = (currentPageRejets - 1) * rowsPerPage;
            const endIndex = Math.min(startIndex + rowsPerPage, totalItems);
            
            // Afficher les rejets de la page courante
            const pageRejets = filteredRejetsList.slice(startIndex, endIndex);
            
            pageRejets.forEach(rejet => {
                const statutInfo = getStatutText(rejet.statut);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(rejet.dateSaisie)}</td>
                    <td><strong>${rejet.reference}</strong></td>
                    <td>${rejet.type}</td>
                    <td>${getDepartementText(rejet.departement)}</td>
                    <td>${rejet.clientNom || '-'}</td>
                    <td>${formatCurrency(rejet.montant)}</td>
                    <td>${getMotifText(rejet.motif)}</td>
                    <td>
                        <span class="status-badge ${statutInfo.class}">
                            ${statutInfo.text}
                        </span>
                    </td>
                    <td>
                        <button class="btn-icon" onclick="viewRejet(${rejet.id})" title="Voir d√©tails">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${currentUser.role === 'superviseur' || currentUser.role === 'gestionnaire' ? `
                        <button class="btn-icon" onclick="viewWorkflow(${rejet.id})" title="Voir workflow">
                            <i class="fas fa-project-diagram"></i>
                        </button>
                        ` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Mettre √† jour l'info de pagination
            document.getElementById('pagination-info').textContent = 
                `Affichage de ${totalItems > 0 ? startIndex + 1 : 0} √† ${endIndex} sur ${totalItems} √©l√©ments`;
            
            // Mettre √† jour les boutons de pagination
            updatePaginationButtons(totalPages);
        }

        function updatePaginationButtons(totalPages) {
            const paginationButtons = document.getElementById('pagination-buttons');
            paginationButtons.innerHTML = '';
            
            // Bouton pr√©c√©dent
            const prevButton = document.createElement('button');
            prevButton.className = 'pagination-btn';
            prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevButton.disabled = currentPageRejets === 1;
            prevButton.onclick = () => {
                if (currentPageRejets > 1) {
                    currentPageRejets--;
                    updatePagination();
                }
            };
            paginationButtons.appendChild(prevButton);
            
            // Boutons de pages
            const maxButtons = 5;
            let startPage = Math.max(1, currentPageRejets - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);
            
            // Ajuster si on est proche de la fin
            if (endPage - startPage + 1 < maxButtons) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }
            
            // Premi√®re page
            if (startPage > 1) {
                const firstButton = document.createElement('button');
                firstButton.className = 'pagination-btn';
                firstButton.textContent = '1';
                firstButton.onclick = () => {
                    currentPageRejets = 1;
                    updatePagination();
                };
                paginationButtons.appendChild(firstButton);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '8px';
                    paginationButtons.appendChild(ellipsis);
                }
            }
            
            // Pages
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.className = `pagination-btn ${i === currentPageRejets ? 'active' : ''}`;
                pageButton.textContent = i;
                pageButton.onclick = () => {
                    currentPageRejets = i;
                    updatePagination();
                };
                paginationButtons.appendChild(pageButton);
            }
            
            // Derni√®re page
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '8px';
                    paginationButtons.appendChild(ellipsis);
                }
                
                const lastButton = document.createElement('button');
                lastButton.className = 'pagination-btn';
                lastButton.textContent = totalPages;
                lastButton.onclick = () => {
                    currentPageRejets = totalPages;
                    updatePagination();
                };
                paginationButtons.appendChild(lastButton);
            }
            
            // Bouton suivant
            const nextButton = document.createElement('button');
            nextButton.className = 'pagination-btn';
            nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextButton.disabled = currentPageRejets === totalPages || totalPages === 0;
            nextButton.onclick = () => {
                if (currentPageRejets < totalPages) {
                    currentPageRejets++;
                    updatePagination();
                }
            };
            paginationButtons.appendChild(nextButton);
        }

        function loadFilterOptions() {
            // Charger les d√©partements
            const deptFilter = document.getElementById('filter-departement');
            if (deptFilter.options.length <= 1) {
                const defaultOption = deptFilter.querySelector('option');
                deptFilter.innerHTML = '';
                deptFilter.appendChild(defaultOption.cloneNode(true));
                
                const allDepts = [...new Set(rejetsData.map(r => r.departement))];
                allDepts.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept;
                    option.textContent = getDepartementText(dept);
                    deptFilter.appendChild(option);
                });
            }
            
            // Charger les statuts
            const statutFilter = document.getElementById('filter-statut');
            if (statutFilter.options.length <= 1) {
                const defaultOption = statutFilter.querySelector('option');
                statutFilter.innerHTML = '';
                statutFilter.appendChild(defaultOption.cloneNode(true));
                
                const allStatuts = [...new Set(rejetsData.map(r => r.statut))];
                allStatuts.forEach(statut => {
                    const option = document.createElement('option');
                    option.value = statut;
                    const statutInfo = getStatutText(statut);
                    option.textContent = statutInfo.text;
                    statutFilter.appendChild(option);
                });
            }
        }

        function loadValidationTable() {
            const tbody = document.getElementById('validation-table-body');
            tbody.innerHTML = '';
            
            let rejetsAVerifier = [];
            
            // Filtrer selon le r√¥le
            if (currentUser.role === 'superviseur') {
                rejetsAVerifier = rejetsData.filter(r => 
                    r.statut === 'attente_validation' || r.statut === 'valide'
                );
            } else if (currentUser.role === 'gestionnaire') {
                rejetsAVerifier = rejetsData.filter(r => r.statut === 'transmis');
            }
            
            // Appliquer le filtre type
            const filterType = document.getElementById('validation-filter-type').value;
            if (filterType === 'a_valider') {
                rejetsAVerifier = rejetsAVerifier.filter(r => r.statut === 'attente_validation');
            } else if (filterType === 'a_recevoir') {
                rejetsAVerifier = rejetsAVerifier.filter(r => r.statut === 'transmis');
            }
            
            // Trier par date (plus ancien d'abord)
            rejetsAVerifier.sort((a, b) => new Date(a.dateSaisie) - new Date(b.dateSaisie));
            
            // Mettre √† jour les statistiques
            document.getElementById('pending-validation').textContent = rejetsAVerifier.length;
            
            // Afficher les rejets
            rejetsAVerifier.forEach(rejet => {
                const statutInfo = getStatutText(rejet.statut);
                const nextAction = getNextAction(rejet.statut, currentUser.role);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${rejet.reference}</strong></td>
                    <td>${rejet.agent}</td>
                    <td>${rejet.clientNom || '-'}</td>
                    <td>${formatCurrency(rejet.montant)}</td>
                    <td>${getMotifText(rejet.motif)}</td>
                    <td>${formatDate(rejet.dateSaisie)}</td>
                    <td>
                        <span class="status-badge ${statutInfo.class}">
                            ${statutInfo.text}
                        </span>
                    </td>
                    <td>
                        <button class="btn-icon" onclick="viewRejet(${rejet.id})" title="Voir d√©tails">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${nextAction ? `
                        <button class="btn btn-${currentUser.role === 'superviseur' ? 'primary' : 'success'}" 
                                onclick="performAction(${rejet.id}, '${rejet.statut}')" 
                                style="padding: 5px 10px; font-size: 0.9rem;">
                            <i class="fas fa-check"></i> ${nextAction}
                        </button>
                        ` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Mettre √† jour les autres statistiques
            const today = new Date().toISOString().split('T')[0];
            const validatedToday = rejetsData.filter(r => {
                const lastAction = r.historique && r.historique.length > 0 ? r.historique[r.historique.length - 1] : null;
                return lastAction && 
                       (lastAction.action === 'valide' || lastAction.action === 'transmis') &&
                       lastAction.user === currentUser.username &&
                       lastAction.date.startsWith(today);
            }).length;
            
            const transmittedToday = rejetsData.filter(r => r.statut === 'transmis').length;
            
            document.getElementById('validated-today').textContent = validatedToday;
            document.getElementById('transmitted-today').textContent = transmittedToday;
        }

        function loadRapports() {
            // Initialiser les dates
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('rapport-date-from').valueAsDate = firstDay;
            document.getElementById('rapport-date-to').valueAsDate = today;
            
            // Mettre √† jour le rapport
            updateRapport();
        }

        function updateRapport() {
            const dateFrom = document.getElementById('rapport-date-from').value;
            const dateTo = document.getElementById('rapport-date-to').value;
            const rapportType = document.getElementById('rapport-type').value;
            
            // Filtrer les rejets par p√©riode
            let filteredRejets = rejetsData;
            if (dateFrom) {
                filteredRejets = filteredRejets.filter(r => r.dateSaisie >= dateFrom);
            }
            if (dateTo) {
                filteredRejets = filteredRejets.filter(r => r.dateSaisie <= dateTo);
            }
            
            // Calculer les statistiques
            const totalRejets = filteredRejets.length;
            const totalMontant = filteredRejets.reduce((sum, r) => sum + r.montant, 0);
            const totalValides = filteredRejets.filter(r => 
                r.statut === 'valide' || r.statut === 'transmis' || r.statut === 'recu'
            ).length;
            const tauxValidation = totalRejets > 0 ? Math.round((totalValides / totalRejets) * 100) : 0;
            
            // Trouver le motif le plus fr√©quent
            const motifCounts = {};
            filteredRejets.forEach(r => {
                motifCounts[r.motif] = (motifCounts[r.motif] || 0) + 1;
            });
            let topMotif = '-';
            let maxCount = 0;
            for (const [motif, count] of Object.entries(motifCounts)) {
                if (count > maxCount) {
                    maxCount = count;
                    topMotif = getMotifText(motif);
                }
            }
            
            // Mettre √† jour l'affichage
            document.getElementById('rapport-period').textContent = 
                `P√©riode : Du ${formatDate(dateFrom)} au ${formatDate(dateTo)}`;
            document.getElementById('rapport-total').textContent = totalRejets;
            document.getElementById('rapport-montant').textContent = formatCurrency(totalMontant);
            document.getElementById('rapport-taux').textContent = tauxValidation + '%';
            document.getElementById('rapport-top-motif').textContent = topMotif;
            
            // Mettre √† jour le tableau
            const tbody = document.getElementById('rapport-table-body');
            tbody.innerHTML = '';
            
            filteredRejets.forEach(rejet => {
                const statutInfo = getStatutText(rejet.statut);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(rejet.dateSaisie)}</td>
                    <td>${rejet.reference}</td>
                    <td>${rejet.type}</td>
                    <td>${getDepartementText(rejet.departement)}</td>
                    <td>${rejet.clientNom || '-'}</td>
                    <td>${formatCurrency(rejet.montant)}</td>
                    <td>${getMotifText(rejet.motif)}</td>
                    <td>${rejet.agent}</td>
                    <td><span class="status-badge ${statutInfo.class}">${statutInfo.text}</span></td>
                `;
                tbody.appendChild(row);
            });
            
            // Mettre √† jour les graphiques
            updateRapportCharts(filteredRejets, dateFrom, dateTo);
            
            // Mettre √† jour la liste des clients
            updateRapportClients(filteredRejets);
            
            // G√©n√©rer l'analyse
            generateRapportAnalyse(filteredRejets, totalRejets, totalMontant, tauxValidation);
        }

        function updateRapportCharts(filteredRejets, dateFrom, dateTo) {
            // Graphique d'√©volution
            const evolutionCtx = document.getElementById('evolutionChart').getContext('2d');
            
            // Calculer l'√©volution par jour
            const evolutionData = {};
            const startDate = new Date(dateFrom);
            const endDate = new Date(dateTo);
            
            // Initialiser tous les jours entre startDate et endDate
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                evolutionData[dateStr] = 0;
            }
            
            // Compter les rejets par jour
            filteredRejets.forEach(rejet => {
                if (evolutionData[rejet.dateSaisie] !== undefined) {
                    evolutionData[rejet.dateSaisie]++;
                }
            });
            
            const evolutionLabels = Object.keys(evolutionData).map(date => 
                new Date(date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })
            );
            const evolutionValues = Object.values(evolutionData);
            
            // Supprimer l'ancien graphique s'il existe
            if (window.evolutionChartInstance) {
                window.evolutionChartInstance.destroy();
            }
            
            window.evolutionChartInstance = new Chart(evolutionCtx, {
                type: 'line',
                data: {
                    labels: evolutionLabels,
                    datasets: [{
                        label: 'Nombre de rejets',
                        data: evolutionValues,
                        borderColor: '#3f51b5',
                        backgroundColor: 'rgba(63, 81, 181, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
            
            // Graphique par d√©partement
            const rapportDeptCtx = document.getElementById('rapportDepartementChart').getContext('2d');
            
            const deptCounts = {};
            filteredRejets.forEach(r => {
                deptCounts[r.departement] = (deptCounts[r.departement] || 0) + 1;
            });
            
            const deptLabels = Object.keys(deptCounts).map(getDepartementText);
            const deptData = Object.values(deptCounts);
            
            // Supprimer l'ancien graphique s'il existe
            if (window.rapportDeptChartInstance) {
                window.rapportDeptChartInstance.destroy();
            }
            
            window.rapportDeptChartInstance = new Chart(rapportDeptCtx, {
                type: 'pie',
                data: {
                    labels: deptLabels,
                    datasets: [{
                        data: deptData,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#8AC926', '#1982C4', '#6A4C93'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
        }

        function updateRapportClients(filteredRejets) {
            // Compter les rejets par client
            const clientCounts = {};
            filteredRejets.forEach(r => {
                if (r.clientNom) {
                    clientCounts[r.clientNom] = (clientCounts[r.clientNom] || 0) + 1;
                }
            });
            
            // Trier par nombre de rejets
            const topClients = Object.entries(clientCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const container = document.getElementById('rapport-clients-list');
            if (topClients.length === 0) {
                container.innerHTML = '<p>Aucun client trouv√© pour cette p√©riode.</p>';
            } else {
                let html = '<div style="overflow-x: auto;"><table style="width: 100%;">';
                html += '<thead><tr><th>Client</th><th>Nombre de rejets</th><th>Montant total</th><th>Taux r√©currence</th></tr></thead><tbody>';
                
                topClients.forEach(([client, count]) => {
                    const clientRejets = filteredRejets.filter(r => r.clientNom === client);
                    const totalMontant = clientRejets.reduce((sum, r) => sum + r.montant, 0);
                    const tauxRecurrence = (count / filteredRejets.length * 100).toFixed(1);
                    
                    html += `
                        <tr>
                            <td><strong>${client}</strong></td>
                            <td>${count}</td>
                            <td>${formatCurrency(totalMontant)}</td>
                            <td>${tauxRecurrence}%</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            }
        }

        function generateRapportAnalyse(filteredRejets, totalRejets, totalMontant, tauxValidation) {
            const container = document.getElementById('rapport-analyse');
            
            if (totalRejets === 0) {
                container.innerHTML = '<p>Aucun rejet trouv√© pour cette p√©riode.</p>';
                return;
            }
            
            // Calculer des statistiques suppl√©mentaires
            const rejetsParJour = totalRejets / filteredRejets.length > 0 ? 
                (totalRejets / (new Set(filteredRejets.map(r => r.dateSaisie)).size)).toFixed(1) : 0;
            
            const rejetsEnAttente = filteredRejets.filter(r => 
                r.statut === 'attente_validation' || r.statut === 'valide'
            ).length;
            
            const tempsMoyenTraitement = calculateAverageProcessingTime(filteredRejets);
            
            // D√©terminer le d√©partement avec le plus de rejets
            const deptCounts = {};
            filteredRejets.forEach(r => {
                deptCounts[r.departement] = (deptCounts[r.departement] || 0) + 1;
            });
            
            let topDept = '-';
            let maxDeptCount = 0;
            for (const [dept, count] of Object.entries(deptCounts)) {
                if (count > maxDeptCount) {
                    maxDeptCount = count;
                    topDept = getDepartementText(dept);
                }
            }
            
            let analyseHTML = `
                <p><strong>Synth√®se :</strong></p>
                <ul>
                    <li>${totalRejets} rejets trait√©s avec un montant total de ${formatCurrency(totalMontant)}</li>
                    <li>Taux de validation : ${tauxValidation}% (${totalRejets - rejetsEnAttente} rejets finalis√©s)</li>
                    <li>${rejetsEnAttente} rejets en attente de traitement</li>
                    <li>Moyenne : ${rejetsParJour} rejets par jour</li>
                    <li>Temps moyen de traitement : ${tempsMoyenTraitement}</li>
                </ul>
                
                <p><strong>Points d'attention :</strong></p>
                <ul>
                    <li>D√©partement avec le plus de rejets : ${topDept} (${maxDeptCount} rejets)</li>
            `;
            
            // Ajouter des recommandations
            if (tauxValidation < 70) {
                analyseHTML += '<li>‚ö†Ô∏è Le taux de validation est bas. Consid√©rez une revue des processus.</li>';
            }
            
            if (rejetsEnAttente > 10) {
                analyseHTML += '<li>‚ö†Ô∏è Nombre important de rejets en attente. Priorisez le traitement.</li>';
            }
            
            if (tempsMoyenTraitement.includes('>48h')) {
                analyseHTML += '<li>‚ö†Ô∏è Temps de traitement trop long. Optimisez le workflow.</li>';
            }
            
            analyseHTML += `
                </ul>
                
                <p><strong>Recommandations :</strong></p>
                <ul>
                    <li>Formation cibl√©e pour le d√©partement ${topDept}</li>
                    <li>Automatisation des validations pour les rejets courants</li>
                    <li>Revue hebdomadaire des rejets r√©currents</li>
                </ul>
            `;
            
            container.innerHTML = analyseHTML;
        }

        function calculateAverageProcessingTime(filteredRejets) {
            const rejetsTraites = filteredRejets.filter(r => 
                r.historique && r.historique.length > 1
            );
            
            if (rejetsTraites.length === 0) return 'Aucun rejet trait√©';
            
            let totalHeures = 0;
            let count = 0;
            
            rejetsTraites.forEach(rejet => {
                const firstAction = rejet.historique[0];
                const lastAction = rejet.historique[rejet.historique.length - 1];
                
                const startTime = new Date(firstAction.date);
                const endTime = new Date(lastAction.date);
                const hours = (endTime - startTime) / (1000 * 60 * 60);
                
                if (hours > 0) {
                    totalHeures += hours;
                    count++;
                }
            });
            
            if (count === 0) return 'N/A';
            
            const avgHours = totalHeures / count;
            
            if (avgHours < 1) {
                return `${Math.round(avgHours * 60)} minutes`;
            } else if (avgHours < 24) {
                return `${avgHours.toFixed(1)} heures`;
            } else if (avgHours < 48) {
                return `${(avgHours / 24).toFixed(1)} jours`;
            } else {
                return '>48 heures';
            }
        }

        function loadAdministration() {
            loadUsersTab();
            loadConfigTab();
            loadOptionsTab();
            loadLogsTab();
        }

        function loadUsersTab() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';
            
            usersData.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.fullname}</td>
                    <td>${user.role}</td>
                    <td>${user.email}</td>
                    <td>${user.departement || '-'}</td>
                    <td>${formatDate(user.created_at)}</td>
                    <td>
                        <span class="status-badge ${user.status === 'active' ? 'status-valide' : 
                                                  user.status === 'suspended' ? 'status-attente-validation' : 
                                                  'status-enregistre'}">
                            ${user.status === 'active' ? 'Actif' : 
                             user.status === 'suspended' ? 'Suspendu' : 'Inactif'}
                        </span>
                        ${user.force_password_change ? '<br><small style="color: #ff9800;">Doit changer mot de passe</small>' : ''}
                    </td>
                    <td>
                        <button class="btn-icon" onclick="editUser(${user.id})" title="Modifier">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon" onclick="openResetPasswordModal(${user.id})" title="R√©initialiser mot de passe">
                            <i class="fas fa-key"></i>
                        </button>
                        <button class="btn-icon" onclick="toggleUserStatus(${user.id})" title="${user.status === 'active' ? 'Suspendre' : 'Activer'}">
                            <i class="fas fa-${user.status === 'active' ? 'pause' : 'play'}"></i>
                        </button>
                        ${user.username !== currentUser.username ? `
                        <button class="btn-icon" onclick="deleteUser(${user.id})" title="Supprimer" style="color: #f44336;">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Charger les d√©partements dans le modal
            const modalDeptSelect = document.getElementById('modal-departement');
            modalDeptSelect.innerHTML = '<option value="">S√©lectionnez...</option>';
            saisieConfig.departements.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                modalDeptSelect.appendChild(option);
            });
        }

        function loadConfigTab() {
            // Charger les valeurs de configuration
            document.getElementById('config-2fa').checked = systemConfig.security['2fa'];
            document.getElementById('config-session').value = systemConfig.security.session_timeout;
            document.getElementById('config-max-attempts').value = systemConfig.security.max_login_attempts;
            
            document.getElementById('config-email-notif').checked = systemConfig.notifications.email;
            document.getElementById('config-supervisor-alerts').checked = systemConfig.notifications.supervisor_alerts;
            document.getElementById('config-auto-reports').value = systemConfig.notifications.auto_reports;
            
            document.getElementById('config-data-retention').value = systemConfig.reports.data_retention;
            document.getElementById('config-pdf-format').value = systemConfig.reports.default_pdf_format;
            document.getElementById('config-include-charts').checked = systemConfig.reports.include_charts;
            
            document.getElementById('config-maintenance').checked = systemConfig.system.maintenance_mode;
            document.getElementById('config-default-language').value = systemConfig.system.default_language;
            document.getElementById('config-auto-backup').checked = systemConfig.system.auto_backup;
        }

        function loadOptionsTab() {
            // Types de pi√®ces
            const piecesList = document.getElementById('piece-types-list');
            piecesList.innerHTML = '';
            saisieConfig.types_pieces.forEach((type, index) => {
                const item = document.createElement('div');
                item.className = 'config-item';
                item.innerHTML = `
                    <span>${type === 'OV' ? 'Ordre de Virement (OV)' : 
                           type === 'RC' ? 'Remise de Ch√®que (R/C)' : 
                           type === 'PC' ? 'Pi√®ce Comptable' : type}</span>
                    <div>
                        <button class="btn-icon" onclick="editConfigItem('piece', ${index})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon" onclick="removeConfigItem('piece', ${index})" style="color: #f44336;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                piecesList.appendChild(item);
            });
            
            // D√©partements
            const deptsList = document.getElementById('departements-list');
            deptsList.innerHTML = '';
            saisieConfig.departements.forEach((dept, index) => {
                const item = document.createElement('div');
                item.className = 'config-item';
                item.innerHTML = `
                    <span>${dept}</span>
                    <div>
                        <button class="btn-icon" onclick="editConfigItem('departement', ${index})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon" onclick="removeConfigItem('departement', ${index})" style="color: #f44336;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                deptsList.appendChild(item);
            });
            
            // Motifs
            const motifsList = document.getElementById('motifs-list');
            motifsList.innerHTML = '';
            saisieConfig.motifs.forEach((motif, index) => {
                const item = document.createElement('div');
                item.className = 'config-item';
                item.innerHTML = `
                    <span>${motif}</span>
                    <div>
                        <button class="btn-icon" onclick="editConfigItem('motif', ${index})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon" onclick="removeConfigItem('motif', ${index})" style="color: #f44336;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                motifsList.appendChild(item);
            });
            
            // Charg√©s
            const chargesList = document.getElementById('charges-list');
            chargesList.innerHTML = '';
            saisieConfig.charges.forEach((charge, index) => {
                const item = document.createElement('div');
                item.className = 'config-item';
                item.innerHTML = `
                    <span>${charge.nom} (${charge.departement})</span>
                    <div>
                        <button class="btn-icon" onclick="editConfigItem('charge', ${index})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon" onclick="removeConfigItem('charge', ${index})" style="color: #f44336;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                chargesList.appendChild(item);
            });
            
            // Champs suppl√©mentaires
            const fieldsConfig = document.getElementById('additional-fields-config');
            fieldsConfig.innerHTML = '';
            saisieConfig.champs_supplementaires.forEach((champ, index) => {
                const item = document.createElement('div');
                item.className = 'config-item';
                item.innerHTML = `
                    <div>
                        <strong>${champ.label}</strong><br>
                        <small>Type: ${champ.type} | ${champ.required ? 'Obligatoire' : 'Optionnel'}</small>
                    </div>
                    <div>
                        <label class="switch">
                            <input type="checkbox" ${champ.required ? 'checked' : ''} 
                                   onchange="toggleFieldRequired(${index}, this.checked)">
                            <span class="slider"></span>
                        </label>
                        <button class="btn-icon" onclick="editAdditionalField(${index})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon" onclick="removeAdditionalField(${index})" style="color: #f44336;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                fieldsConfig.appendChild(item);
            });
        }

        function loadLogsTab() {
            const tbody = document.getElementById('logs-table-body');
            tbody.innerHTML = '';
            
            // Filtrer les logs
            const dateFrom = document.getElementById('log-date-from').value;
            const dateTo = document.getElementById('log-date-to').value;
            const logLevel = document.getElementById('log-level').value;
            
            let filteredLogs = activityLogs;
            
            if (dateFrom) {
                filteredLogs = filteredLogs.filter(log => log.timestamp >= dateFrom + ' 00:00:00');
            }
            if (dateTo) {
                filteredLogs = filteredLogs.filter(log => log.timestamp <= dateTo + ' 23:59:59');
            }
            if (logLevel) {
                filteredLogs = filteredLogs.filter(log => log.level === logLevel);
            }
            
            // Trier par date (plus r√©cent d'abord)
            filteredLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Afficher les logs
            filteredLogs.forEach(log => {
                const row = document.createElement('tr');
                let levelClass = '';
                switch(log.level) {
                    case 'error': levelClass = 'status-attente-validation'; break;
                    case 'warning': levelClass = 'status-enregistre'; break;
                    case 'security': levelClass = 'status-transmis'; break;
                    default: levelClass = 'status-valide';
                }
                
                row.innerHTML = `
                    <td>${formatDateTime(log.timestamp)}</td>
                    <td>
                        <span class="status-badge ${levelClass}">
                            ${log.level.toUpperCase()}
                        </span>
                    </td>
                    <td>${log.user}</td>
                    <td>${log.action}</td>
                    <td>${log.details}</td>
                    <td><small>${log.ip}</small></td>
                `;
                tbody.appendChild(row);
            });
        }

        // ============================================
        // GESTION DES MODALES
        // ============================================
        
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function openUserModal(userId = null) {
            const modal = document.getElementById('user-modal');
            const title = document.getElementById('modal-user-title');
            const form = document.getElementById('user-form');
            
            if (userId) {
                // Mode √©dition
                const user = usersData.find(u => u.id === userId);
                if (user) {
                    title.textContent = 'Modifier l\'utilisateur';
                    document.getElementById('modal-user-id').value = user.id;
                    document.getElementById('modal-username').value = user.username;
                    document.getElementById('modal-fullname').value = user.fullname;
                    document.getElementById('modal-email').value = user.email;
                    document.getElementById('modal-role').value = user.role;
                    document.getElementById('modal-departement').value = user.departement || '';
                    document.getElementById('modal-status').value = user.status;
                    
                    // Permissions
                    document.getElementById('permission-export').checked = user.permissions.includes('export');
                    document.getElementById('permission-reports').checked = user.permissions.includes('reports');
                    document.getElementById('permission-view-all').checked = user.permissions.includes('view_all');
                    
                    // Rendre le champ mot de passe optionnel en √©dition
                    document.getElementById('modal-password').removeAttribute('required');
                    document.getElementById('modal-confirm-password').removeAttribute('required');
                }
            } else {
                // Mode cr√©ation
                title.textContent = 'Ajouter un utilisateur';
                form.reset();
                document.getElementById('modal-user-id').value = '';
                document.getElementById('modal-password').setAttribute('required', 'true');
                document.getElementById('modal-confirm-password').setAttribute('required', 'true');
            }
            
            showModal('user-modal');
        }

        // ============================================
        // FONCTIONS POUR LES ACTIONS
        // ============================================
        
        function viewRejet(id) {
            const rejet = rejetsData.find(r => r.id === id);
            if (rejet) {
                const statutInfo = getStatutText(rejet.statut);
                let historiqueText = '';
                if (rejet.historique && rejet.historique.length > 0) {
                    historiqueText = '\n\nHistorique des actions:\n';
                    rejet.historique.forEach(h => {
                        const actionText = h.action === 'enregistre' ? 'Enregistr√© par' :
                                          h.action === 'valide' ? 'Valid√© par' :
                                          h.action === 'transmis' ? 'Transmis par' :
                                          h.action === 'recu' ? 'Re√ßu par' : h.action;
                        historiqueText += `‚Ä¢ ${actionText} ${h.user} (${h.role}) - ${h.date}\n`;
                    });
                }
                
                alert(`D√©tails du rejet:\n
R√©f√©rence: ${rejet.reference}
Type: ${rejet.type}
D√©partement: ${getDepartementText(rejet.departement)}
Client: ${rejet.clientNom || 'Non sp√©cifi√©'}
Montant: ${formatCurrency(rejet.montant)}
Motif: ${getMotifText(rejet.motif)}
Date op√©ration: ${formatDate(rejet.date)}
Agent OPS: ${rejet.agent}
Statut: ${statutInfo.text}
Commentaire: ${rejet.commentaire || 'Aucun'}
${historiqueText}`);
            }
        }

        function viewWorkflow(id) {
            const rejet = rejetsData.find(r => r.id === id);
            if (rejet) {
                // Cr√©er une modale simple pour le workflow
                let workflowHTML = `
                    <div style="max-width: 500px;">
                        <h3 style="margin-bottom: 15px;">Workflow du rejet ${rejet.reference}</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                `;
                
                const steps = [
                    { status: 'enregistre', label: 'Enregistr√© par Agent OPS', icon: 'fa-user' },
                    { status: 'valide', label: 'Valid√© par Superviseur', icon: 'fa-user-check' },
                    { status: 'transmis', label: 'Transmis √† Gestionnaire', icon: 'fa-paper-plane' },
                    { status: 'recu', label: 'Re√ßu par Gestionnaire', icon: 'fa-check-double' }
                ];
                
                steps.forEach((step, index) => {
                    const historiqueStep = rejet.historique ? 
                        rejet.historique.find(h => h.action === step.status) : null;
                    
                    let stepContent = '';
                    
                    if (historiqueStep) {
                        stepContent = `
                            <div style="color: #4caf50; font-size: 0.9rem;">
                                <i class="fas ${step.icon}"></i> ${step.label}
                            </div>
                            <div style="font-size: 0.8rem; color: #666;">
                                Par: ${historiqueStep.user}<br>
                                Le: ${historiqueStep.date}
                            </div>
                        `;
                    } else if (rejet.statut === step.status) {
                        stepContent = `
                            <div style="color: #2196f3; font-size: 0.9rem;">
                                <i class="fas ${step.icon}"></i> ${step.label}
                            </div>
                            <div style="font-size: 0.8rem; color: #666;">
                                En cours...
                            </div>
                        `;
                    } else {
                        stepContent = `
                            <div style="color: #9e9e9e; font-size: 0.9rem;">
                                <i class="fas ${step.icon}"></i> ${step.label}
                            </div>
                            <div style="font-size: 0.8rem; color: #9e9e9e;">
                                En attente
                            </div>
                        `;
                    }
                    
                    workflowHTML += `
                        <div style="display: flex; align-items: center; gap: 15px; padding: 10px; background: ${historiqueStep ? '#e8f5e9' : rejet.statut === step.status ? '#e3f2fd' : '#f5f5f5'}; border-radius: 8px;">
                            <div style="width: 30px; height: 30px; border-radius: 50%; background: ${historiqueStep ? '#4caf50' : rejet.statut === step.status ? '#2196f3' : '#e0e0e0'}; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                                ${index + 1}
                            </div>
                            <div>
                                ${stepContent}
                            </div>
                        </div>
                    `;
                });
                
                workflowHTML += `
                        </div>
                    </div>
                `;
                
                // Cr√©er une modale simple
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                `;
                
                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white;
                    padding: 20px;
                    border-radius: 10px;
                    max-width: 600px;
                    max-height: 80vh;
                    overflow-y: auto;
                `;
                modalContent.innerHTML = workflowHTML;
                
                modal.appendChild(modalContent);
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });
                
                document.body.appendChild(modal);
            }
        }

        function performAction(id, currentStatut) {
            const rejet = rejetsData.find(r => r.id === id);
            if (!rejet) return;
            
            let newAction = '';
            let newStatut = '';
            let message = '';
            
            if (currentUser.role === 'superviseur') {
                if (currentStatut === 'attente_validation') {
                    newAction = 'valide';
                    newStatut = 'valide';
                    message = `Voulez-vous valider le rejet ${rejet.reference}?`;
                } else if (currentStatut === 'valide') {
                    newAction = 'transmis';
                    newStatut = 'transmis';
                    message = `Voulez-vous transmettre le rejet ${rejet.reference} au gestionnaire?`;
                }
            } else if (currentUser.role === 'gestionnaire' && currentStatut === 'transmis') {
                newAction = 'recu';
                newStatut = 'recu';
                message = `Voulez-vous confirmer la r√©ception du rejet ${rejet.reference}?`;
            }
            
            if (!newAction) {
                alert('Action non disponible pour votre r√¥le ou le statut actuel.');
                return;
            }
            
            if (confirm(message)) {
                // Mettre √† jour le statut
                rejet.statut = newStatut;
                
                // Ajouter √† l'historique
                rejet.historique.push({
                    action: newAction,
                    user: currentUser.username,
                    date: new Date().toISOString().replace('T', ' ').substring(0, 16),
                    role: currentUser.role
                });
                
                saveAllData();
                addLog('info', `Action ${newAction}`, `Rejet ${rejet.reference} ${newAction} par ${currentUser.username}`);
                
                // Mettre √† jour l'affichage
                if (currentPage === 'validation') {
                    loadValidationTable();
                } else if (currentPage === 'rejets') {
                    loadRejetsTable();
                }
                updateDashboard();
                
                // Message de confirmation
                const actionText = newAction === 'valide' ? 'valid√©' :
                                  newAction === 'transmis' ? 'transmis au gestionnaire' :
                                  newAction === 'recu' ? 'marqu√© comme re√ßu' : newAction;
                alert(`Rejet ${rejet.reference} ${actionText} avec succ√®s!`);
            }
        }

        function editUser(userId) {
            openUserModal(userId);
        }

        function toggleUserStatus(userId) {
            const user = usersData.find(u => u.id === userId);
            if (user) {
                const newStatus = user.status === 'active' ? 'suspended' : 'active';
                const message = user.status === 'active' ? 
                    `Voulez-vous suspendre l'acc√®s de ${user.username} ?` :
                    `Voulez-vous r√©activer l'acc√®s de ${user.username} ?`;
                
                if (confirm(message)) {
                    user.status = newStatus;
                    saveAllData();
                    addLog('security', 'Modification utilisateur', 
                          `Statut de ${user.username} chang√© en ${newStatus} par ${currentUser.username}`);
                    loadUsersTab();
                    alert(`Utilisateur ${user.username} ${newStatus === 'active' ? 'activ√©' : 'suspendu'} avec succ√®s.`);
                }
            }
        }

        function deleteUser(userId) {
            const user = usersData.find(u => u.id === userId);
            if (user) {
                if (confirm(`√ätes-vous s√ªr de vouloir supprimer d√©finitivement l'utilisateur ${user.username} ?`)) {
                    if (user.username === currentUser.username) {
                        alert('Vous ne pouvez pas supprimer votre propre compte.');
                        return;
                    }
                    
                    usersData = usersData.filter(u => u.id !== userId);
                    saveAllData();
                    addLog('security', 'Suppression utilisateur', 
                          `Utilisateur ${user.username} supprim√© par ${currentUser.username}`);
                    loadUsersTab();
                    alert('Utilisateur supprim√© avec succ√®s.');
                }
            }
        }

        function saveUser() {
            const form = document.getElementById('user-form');
            const userId = document.getElementById('modal-user-id').value;
            const password = document.getElementById('modal-password').value;
            const confirmPassword = document.getElementById('modal-confirm-password').value;
            
            // Validation
            if (password && password !== confirmPassword) {
                alert('Les mots de passe ne correspondent pas.');
                return;
            }
            
            if (userId) {
                // Mise √† jour
                const user = usersData.find(u => u.id === parseInt(userId));
                if (user) {
                    user.username = document.getElementById('modal-username').value;
                    user.fullname = document.getElementById('modal-fullname').value;
                    user.email = document.getElementById('modal-email').value;
                    user.role = document.getElementById('modal-role').value;
                    user.departement = document.getElementById('modal-departement').value;
                    user.status = document.getElementById('modal-status').value;
                    
                    if (password) {
                        user.password = password;
                    }
                    
                    // Permissions
                    user.permissions = [];
                    if (document.getElementById('permission-export').checked) user.permissions.push('export');
                    if (document.getElementById('permission-reports').checked) user.permissions.push('reports');
                    if (document.getElementById('permission-view-all').checked) user.permissions.push('view_all');
                    
                    addLog('info', 'Mise √† jour utilisateur', 
                          `Utilisateur ${user.username} mis √† jour par ${currentUser.username}`);
                }
            } else {
                // Cr√©ation
                const newUser = {
                    id: usersData.length > 0 ? Math.max(...usersData.map(u => u.id)) + 1 : 1,
                    username: document.getElementById('modal-username').value,
                    fullname: document.getElementById('modal-fullname').value,
                    password: password,
                    email: document.getElementById('modal-email').value,
                    role: document.getElementById('modal-role').value,
                    departement: document.getElementById('modal-departement').value,
                    status: document.getElementById('modal-status').value,
                    permissions: [],
                    created_at: new Date().toISOString().split('T')[0],
                    force_password_change: false
                };
                
                // Permissions
                if (document.getElementById('permission-export').checked) newUser.permissions.push('export');
                if (document.getElementById('permission-reports').checked) newUser.permissions.push('reports');
                if (document.getElementById('permission-view-all').checked) newUser.permissions.push('view_all');
                
                usersData.push(newUser);
                addLog('info', 'Cr√©ation utilisateur', 
                      `Nouvel utilisateur ${newUser.username} cr√©√© par ${currentUser.username}`);
            }
            
            saveAllData();
            closeModal('user-modal');
            loadUsersTab();
            alert('Utilisateur enregistr√© avec succ√®s.');
        }

        function saveConfig() {
            // S√©curit√©
            systemConfig.security['2fa'] = document.getElementById('config-2fa').checked;
            systemConfig.security.session_timeout = parseInt(document.getElementById('config-session').value) || 30;
            systemConfig.security.max_login_attempts = parseInt(document.getElementById('config-max-attempts').value) || 3;
            
            // Notifications
            systemConfig.notifications.email = document.getElementById('config-email-notif').checked;
            systemConfig.notifications.supervisor_alerts = document.getElementById('config-supervisor-alerts').checked;
            systemConfig.notifications.auto_reports = document.getElementById('config-auto-reports').value;
            
            // Rapports
            systemConfig.reports.data_retention = parseInt(document.getElementById('config-data-retention').value) || 365;
            systemConfig.reports.default_pdf_format = document.getElementById('config-pdf-format').value;
            systemConfig.reports.include_charts = document.getElementById('config-include-charts').checked;
            
            // Syst√®me
            systemConfig.system.maintenance_mode = document.getElementById('config-maintenance').checked;
            systemConfig.system.default_language = document.getElementById('config-default-language').value;
            systemConfig.system.auto_backup = document.getElementById('config-auto-backup').checked;
            
            saveAllData();
            addLog('info', 'Configuration syst√®me', 'Configuration syst√®me mise √† jour');
            alert('Configuration sauvegard√©e avec succ√®s.');
        }

        function resetConfig() {
            if (confirm('Voulez-vous r√©initialiser la configuration aux valeurs par d√©faut ?')) {
                systemConfig = {
                    security: {
                        '2fa': false,
                        session_timeout: 30,
                        max_login_attempts: 3
                    },
                    notifications: {
                        email: true,
                        supervisor_alerts: true,
                        auto_reports: 'weekly'
                    },
                    reports: {
                        data_retention: 365,
                        default_pdf_format: 'A4',
                        include_charts: true
                    },
                    system: {
                        maintenance_mode: false,
                        default_language: 'fr',
                        auto_backup: true
                    }
                };
                
                saveAllData();
                loadConfigTab();
                addLog('info', 'Configuration syst√®me', 'Configuration r√©initialis√©e aux valeurs par d√©faut');
                alert('Configuration r√©initialis√©e avec succ√®s.');
            }
        }

        function addConfigItem(type) {
            const value = prompt(`Entrez le nouveau ${type}:`);
            if (value && value.trim()) {
                switch(type) {
                    case 'piece':
                        saisieConfig.types_pieces.push(value.trim());
                        break;
                    case 'departement':
                        saisieConfig.departements.push(value.trim());
                        break;
                    case 'motif':
                        saisieConfig.motifs.push(value.trim());
                        break;
                    case 'charge':
                        const departement = prompt('D√©partement du charg√©:');
                        if (departement) {
                            const id = value.toLowerCase().replace(/[^a-z0-9]/g, '_');
                            saisieConfig.charges.push({
                                id: id,
                                nom: value.trim(),
                                departement: departement.trim()
                            });
                        }
                        break;
                }
                
                saveAllData();
                addLog('info', 'Configuration saisie', `${type} ajout√©: ${value}`);
                loadOptionsTab();
                if (currentPage === 'saisie') loadSaisieForm();
                alert(`${type} ajout√© avec succ√®s.`);
            }
        }

        function editConfigItem(type, index) {
            let currentValue = '';
            let promptMessage = '';
            
            switch(type) {
                case 'piece':
                    currentValue = saisieConfig.types_pieces[index];
                    promptMessage = `Modifier le type de pi√®ce:`;
                    break;
                case 'departement':
                    currentValue = saisieConfig.departements[index];
                    promptMessage = `Modifier le d√©partement:`;
                    break;
                case 'motif':
                    currentValue = saisieConfig.motifs[index];
                    promptMessage = `Modifier le motif:`;
                    break;
                case 'charge':
                    currentValue = saisieConfig.charges[index].nom;
                    promptMessage = `Modifier le nom du charg√©:`;
                    break;
            }
            
            const newValue = prompt(promptMessage, currentValue);
            if (newValue && newValue.trim()) {
                switch(type) {
                    case 'piece':
                        saisieConfig.types_pieces[index] = newValue.trim();
                        break;
                    case 'departement':
                        saisieConfig.departements[index] = newValue.trim();
                        break;
                    case 'motif':
                        saisieConfig.motifs[index] = newValue.trim();
                        break;
                    case 'charge':
                        saisieConfig.charges[index].nom = newValue.trim();
                        break;
                }
                
                saveAllData();
                addLog('info', 'Configuration saisie', `${type} modifi√©: ${newValue}`);
                loadOptionsTab();
                if (currentPage === 'saisie') loadSaisieForm();
                alert(`${type} modifi√© avec succ√®s.`);
            }
        }

        function removeConfigItem(type, index) {
            if (confirm(`√ätes-vous s√ªr de vouloir supprimer ce ${type} ?`)) {
                switch(type) {
                    case 'piece':
                        const piece = saisieConfig.types_pieces[index];
                        saisieConfig.types_pieces.splice(index, 1);
                        addLog('info', 'Configuration saisie', `Type de pi√®ce supprim√©: ${piece}`);
                        break;
                    case 'departement':
                        const dept = saisieConfig.departements[index];
                        saisieConfig.departements.splice(index, 1);
                        addLog('info', 'Configuration saisie', `D√©partement supprim√©: ${dept}`);
                        break;
                    case 'motif':
                        const motif = saisieConfig.motifs[index];
                        saisieConfig.motifs.splice(index, 1);
                        addLog('info', 'Configuration saisie', `Motif supprim√©: ${motif}`);
                        break;
                    case 'charge':
                        const charge = saisieConfig.charges[index];
                        saisieConfig.charges.splice(index, 1);
                        addLog('info', 'Configuration saisie', `Charg√© supprim√©: ${charge.nom}`);
                        break;
                }
                
                saveAllData();
                loadOptionsTab();
                if (currentPage === 'saisie') loadSaisieForm();
                alert(`${type} supprim√© avec succ√®s.`);
            }
        }

        function addAdditionalField() {
            const label = prompt('Label du champ:');
            if (!label) return;
            
            const type = prompt('Type du champ (text, number, date, select, textarea):', 'text');
            if (!['text', 'number', 'date', 'select', 'textarea'].includes(type)) {
                alert('Type invalide. Choisissez parmi: text, number, date, select, textarea');
                return;
            }
            
            let options = [];
            if (type === 'select') {
                const optionsStr = prompt('Options (s√©par√©es par des virgules):');
                if (optionsStr) {
                    options = optionsStr.split(',').map(opt => opt.trim());
                }
            }
            
            const required = confirm('Ce champ est-il obligatoire ?');
            
            const newField = {
                id: label.toLowerCase().replace(/[^a-z0-9]/g, '_'),
                label: label.trim(),
                type: type,
                options: options,
                required: required
            };
            
            saisieConfig.champs_supplementaires.push(newField);
            saveAllData();
            addLog('info', 'Configuration saisie', `Champ suppl√©mentaire ajout√©: ${label}`);
            loadOptionsTab();
            if (currentPage === 'saisie') loadSaisieForm();
            alert('Champ ajout√© avec succ√®s.');
        }

        function editAdditionalField(index) {
            const champ = saisieConfig.champs_supplementaires[index];
            
            const newLabel = prompt('Nouveau label:', champ.label);
            if (!newLabel) return;
            
            const newType = prompt('Nouveau type (text, number, date, select, textarea):', champ.type);
            if (!['text', 'number', 'date', 'select', 'textarea'].includes(newType)) {
                alert('Type invalide. Choisissez parmi: text, number, date, select, textarea');
                return;
            }
            
            let newOptions = champ.options;
            if (newType === 'select') {
                const optionsStr = prompt('Options (s√©par√©es par des virgules):', champ.options.join(', '));
                if (optionsStr) {
                    newOptions = optionsStr.split(',').map(opt => opt.trim());
                }
            }
            
            const newRequired = confirm('Ce champ est-il obligatoire ?', champ.required);
            
            champ.label = newLabel.trim();
            champ.type = newType;
            champ.options = newOptions;
            champ.required = newRequired;
            champ.id = newLabel.toLowerCase().replace(/[^a-z0-9]/g, '_');
            
            saveAllData();
            addLog('info', 'Configuration saisie', `Champ suppl√©mentaire modifi√©: ${newLabel}`);
            loadOptionsTab();
            if (currentPage === 'saisie') loadSaisieForm();
            alert('Champ modifi√© avec succ√®s.');
        }

        function removeAdditionalField(index) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce champ ?')) {
                const champ = saisieConfig.champs_supplementaires[index];
                saisieConfig.champs_supplementaires.splice(index, 1);
                saveAllData();
                addLog('info', 'Configuration saisie', `Champ suppl√©mentaire supprim√©: ${champ.label}`);
                loadOptionsTab();
                if (currentPage === 'saisie') loadSaisieForm();
                alert('Champ supprim√© avec succ√®s.');
            }
        }

        function toggleFieldRequired(index, required) {
            saisieConfig.champs_supplementaires[index].required = required;
            saveAllData();
        }

        // ============================================
        // GENERATION PDF
        // ============================================
        
        async function generatePDF() {
            try {
                // Afficher un message de chargement
                const originalBtnText = document.getElementById('generate-pdf').innerHTML;
                document.getElementById('generate-pdf').innerHTML = '<i class="fas fa-spinner fa-spin"></i> G√©n√©ration en cours...';
                document.getElementById('generate-pdf').disabled = true;
                
                // Capturer le contenu du rapport
                const element = document.getElementById('rapport-content');
                
                // Utiliser html2canvas pour capturer le contenu
                const canvas = await html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });
                
                const imgData = canvas.toDataURL('image/png');
                const pdf = new window.jspdf.jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: systemConfig.reports.default_pdf_format
                });
                
                const imgWidth = 190;
                const pageHeight = pdf.internal.pageSize.height;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 10;
                
                // Ajouter l'en-t√™te
                pdf.setFontSize(16);
                pdf.setTextColor(26, 35, 126);
                pdf.text('Rapport d√©taill√© des rejets', 105, 15, { align: 'center' });
                
                pdf.setFontSize(10);
                pdf.setTextColor(100, 100, 100);
                pdf.text('Syst√®me de Gestion des Rejets - Banque', 105, 20, { align: 'center' });
                pdf.text(`G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')} par ${currentUser.username}`, 105, 25, { align: 'center' });
                
                // Ajouter l'image
                pdf.addImage(imgData, 'PNG', 10, 30, imgWidth, imgHeight);
                
                heightLeft -= pageHeight;
                
                // Ajouter des pages suppl√©mentaires si n√©cessaire
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                // Ajouter le pied de page
                const pageCount = pdf.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    pdf.setPage(i);
                    pdf.setFontSize(8);
                    pdf.setTextColor(100, 100, 100);
                    pdf.text(`Page ${i} / ${pageCount}`, 105, 287, { align: 'center' });
                    pdf.text('Document confidentiel - Usage interne uniquement', 105, 290, { align: 'center' });
                }
                
                // T√©l√©charger le PDF
                const fileName = `rapport_rejets_${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);
                
                addLog('info', 'G√©n√©ration PDF', `Rapport PDF g√©n√©r√©: ${fileName}`);
                
                // Restaurer le bouton
                document.getElementById('generate-pdf').innerHTML = originalBtnText;
                document.getElementById('generate-pdf').disabled = false;
                
                alert('Rapport PDF g√©n√©r√© avec succ√®s !');
            } catch (error) {
                console.error('Erreur lors de la g√©n√©ration du PDF:', error);
                alert('Erreur lors de la g√©n√©ration du PDF. Veuillez r√©essayer.');
                
                // Restaurer le bouton en cas d'erreur
                document.getElementById('generate-pdf').innerHTML = '<i class="fas fa-file-pdf"></i> G√©n√©rer PDF';
                document.getElementById('generate-pdf').disabled = false;
            }
        }

        function generateQuickReport() {
            // G√©n√©rer un rapport rapide du dashboard
            const today = new Date().toISOString().split('T')[0];
            const rejetsToday = rejetsData.filter(r => r.dateSaisie === today).length;
            const rejetsMonth = rejetsData.filter(r => {
                const date = new Date(r.dateSaisie);
                const now = new Date();
                return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
            }).length;
            
            const totalValides = rejetsData.filter(r => r.statut === 'valide' || r.statut === 'transmis' || r.statut === 'recu').length;
            const tauxValidation = rejetsData.length > 0 ? Math.round((totalValides / rejetsData.length) * 100) : 0;
            
            // Cr√©er un PDF simple
            const pdf = new window.jspdf.jsPDF();
            
            pdf.setFontSize(18);
            pdf.setTextColor(26, 35, 126);
            pdf.text('Rapport rapide - Tableau de bord', 105, 20, { align: 'center' });
            
            pdf.setFontSize(12);
            pdf.setTextColor(0, 0, 0);
            pdf.text(`Date : ${new Date().toLocaleDateString('fr-FR')}`, 20, 40);
            pdf.text(`G√©n√©r√© par : ${currentUser.username}`, 20, 50);
            
            pdf.setFontSize(14);
            pdf.setTextColor(63, 81, 181);
            pdf.text('Statistiques cl√©s', 20, 70);
            
            pdf.setFontSize(12);
            pdf.setTextColor(0, 0, 0);
            pdf.text(`‚Ä¢ Rejets aujourd'hui : ${rejetsToday}`, 30, 85);
            pdf.text(`‚Ä¢ Rejets ce mois : ${rejetsMonth}`, 30, 95);
            pdf.text(`‚Ä¢ Taux de validation : ${tauxValidation}%`, 30, 105);
            
            // Ajouter un tableau des derniers rejets
            pdf.setFontSize(14);
            pdf.setTextColor(63, 81, 181);
            pdf.text('Derniers rejets', 20, 125);
            
            const lastRejets = rejetsData.slice(-5).reverse();
            let y = 140;
            
            pdf.setFontSize(10);
            lastRejets.forEach(rejet => {
                const statutInfo = getStatutText(rejet.statut);
                pdf.text(`${formatDate(rejet.dateSaisie)} - ${rejet.reference} - ${getMotifText(rejet.motif)} - ${statutInfo.text}`, 30, y);
                y += 7;
            });
            
            // Pied de page
            pdf.setFontSize(8);
            pdf.setTextColor(100, 100, 100);
            pdf.text('Document g√©n√©r√© automatiquement - Syst√®me de Gestion des Rejets', 105, 287, { align: 'center' });
            
            const fileName = `rapport_rapide_${today}.pdf`;
            pdf.save(fileName);
            
            addLog('info', 'G√©n√©ration rapport rapide', 'Rapport rapide g√©n√©r√© depuis le dashboard');
            alert('Rapport rapide g√©n√©r√© avec succ√®s !');
        }

        // ============================================
        // GESTION DES √âV√âNEMENTS
        // ============================================
        
        function setupEventListeners() {
            // Connexion
            document.getElementById('loginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const role = document.getElementById('loginRole').value;
                const language = document.getElementById('loginLanguage').value;
                
                // V√©rifier les informations de connexion dans les donn√©es locales
                const user = usersData.find(u => 
                    u.email === email && 
                    u.password === password && 
                    u.role === role &&
                    u.status === 'active'
                );
                
                if (user) {
                    // V√©rifier si l'utilisateur doit changer son mot de passe
                    if (user.force_password_change) {
                        alert('Vous devez changer votre mot de passe avant de pouvoir vous connecter.');
                        openChangePasswordModal();
                        return;
                    }
                    
                    currentUser = {
                        id: user.id,
                        username: user.username,
                        fullname: user.fullname,
                        role: user.role,
                        permissions: user.permissions,
                        language: language
                    };
                    
                    // Sauvegarder la langue
                    currentLanguage = language;
                    
                    // Cacher login, afficher app
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('main-app').style.display = 'block';
                    
                    // Mettre √† jour l'interface utilisateur
                    document.getElementById('current-user').textContent = `${user.fullname} (${user.role})`;
                    document.getElementById('current-agent').textContent = user.fullname;
                    document.getElementById('language-switcher').value = language;
                    
                    // Afficher/masquer les menus selon le r√¥le
                    if (user.role === 'superviseur' || user.role === 'gestionnaire') {
                        document.getElementById('validation-nav').style.display = 'flex';
                    }
                    if (user.role === 'superviseur') {
                        document.getElementById('admin-nav').style.display = 'flex';
                    }
                    
                    // Ajouter un log
                    addLog('info', 'Connexion', `Connexion r√©ussie pour ${user.username}`);
                    
                    // Afficher le dashboard
                    showPage('dashboard');
                } else {
                    alert('Identifiants incorrects ou compte d√©sactiv√©.');
                    addLog('warning', 'Tentative connexion', `√âchec connexion pour ${email}`);
                }
            });
            
            // D√©connexion
            document.getElementById('logout-btn').addEventListener('click', function() {
                addLog('info', 'D√©connexion', `D√©connexion de ${currentUser.username}`);
                currentUser = null;
                document.getElementById('main-app').style.display = 'none';
                document.getElementById('login-screen').style.display = 'block';
                document.getElementById('loginForm').reset();
            });
            
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const page = this.getAttribute('data-page');
                    showPage(page);
                });
            });
            
            // Tabs administration
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Mettre √† jour les tabs
                    document.querySelectorAll('.tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Afficher le contenu correspondant
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
            
            // Changement de langue
            document.getElementById('language-switcher').addEventListener('change', function() {
                currentLanguage = this.value;
                alert(`Langue chang√©e en ${this.value === 'fr' ? 'Fran√ßais' : 'English'}. Pour la d√©mo, seul le fran√ßais est pleinement impl√©ment√©.`);
            });
            
            // Lien pour changer le mot de passe sur la page de connexion
            document.getElementById('change-password-link').addEventListener('click', openChangePasswordModal);
            
            // Sauvegarde changement mot de passe
            document.getElementById('save-change-password-btn').addEventListener('click', changePassword);
            
            // Sauvegarde r√©initialisation mot de passe (admin)
            document.getElementById('save-reset-password-btn').addEventListener('click', resetPassword);
            
            // Formulaire de saisie
            document.getElementById('type-piece').addEventListener('change', function() {
                if (this.value) {
                    const ref = generateReference(this.value);
                    document.getElementById('reference').value = ref;
                }
            });
            
            // Bouton ajouter charg√©
            document.getElementById('add-charge-btn').addEventListener('click', function() {
                const nom = prompt("Nom du nouveau charg√© (ex: Nom Pr√©nom):");
                if (nom) {
                    const id = nom.toLowerCase().replace(/[^a-z0-9]/g, '_');
                    const departement = prompt("D√©partement du charg√©:");
                    if (departement) {
                        // Ajouter √† la configuration
                        saisieConfig.charges.push({
                            id: id,
                            nom: nom.toUpperCase(),
                            departement: departement
                        });
                        
                        // Ajouter √† la liste d√©roulante
                        const select = document.getElementById('charge');
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = nom.toUpperCase();
                        select.appendChild(option);
                        select.value = id;
                        
                        saveAllData();
                        alert(`Charg√© "${nom}" ajout√© avec succ√®s!`);
                    }
                }
            });
            
            // Bouton ajouter motif
            document.getElementById('add-motif-btn').addEventListener('click', function() {
                const motif = prompt("Nouveau motif de rejet:");
                if (motif) {
                    // Ajouter √† la configuration
                    saisieConfig.motifs.push(motif);
                    
                    // Ajouter √† la liste d√©roulante
                    const select = document.getElementById('motif');
                    const option = document.createElement('option');
                    const value = motif.toLowerCase().replace(/[^a-z0-9]/g, '_');
                    option.value = value;
                    option.textContent = motif;
                    select.appendChild(option);
                    select.value = value;
                    
                    saveAllData();
                    alert(`Motif "${motif}" ajout√© avec succ√®s!`);
                }
            });
            
            // Annuler la saisie
            document.getElementById('cancel-btn').addEventListener('click', function() {
                if (confirm('Voulez-vous annuler la saisie? Les donn√©es non enregistr√©es seront perdues.')) {
                    document.getElementById('rejet-form').reset();
                    document.getElementById('reference').value = 'G√©n√©r√© automatiquement';
                    showPage('dashboard');
                }
            });
            
            // Enregistrer un rejet
            document.getElementById('rejet-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Validation basique
                const typePiece = document.getElementById('type-piece').value;
                const departement = document.getElementById('departement').value;
                const charge = document.getElementById('charge').value;
                const montant = parseFloat(document.getElementById('montant').value);
                const dateOp = document.getElementById('date-operation').value;
                const motif = document.getElementById('motif').value;
                
                if (!typePiece || !departement || !charge || !montant || !dateOp || !motif) {
                    alert('Veuillez remplir tous les champs obligatoires (*)');
                    return;
                }
                
                // Collecter les champs suppl√©mentaires
                const champsSupplementaires = {};
                saisieConfig.champs_supplementaires.forEach(champ => {
                    const fieldValue = document.getElementById(`field-${champ.id}`)?.value;
                    if (fieldValue) {
                        champsSupplementaires[champ.id] = fieldValue;
                    }
                });
                
                // Cr√©er le nouvel objet rejet avec workflow
                const newRejet = {
                    id: rejetsData.length > 0 ? Math.max(...rejetsData.map(r => r.id)) + 1 : 1,
                    reference: document.getElementById('reference').value,
                    type: typePiece,
                    departement: departement,
                    charge: charge,
                    clientNom: document.getElementById('client-nom').value || '',
                    clientCompte: document.getElementById('client-compte').value || '',
                    montant: montant,
                    date: dateOp,
                    motif: motif,
                    commentaire: document.getElementById('commentaire').value || '',
                    champsSupplementaires: champsSupplementaires,
                    agent: currentUser.username,
                    dateSaisie: new Date().toISOString().split('T')[0],
                    statut: 'attente_validation',
                    historique: [
                        { 
                            action: 'enregistre', 
                            user: currentUser.username, 
                            date: new Date().toISOString().replace('T', ' ').substring(0, 16),
                            role: currentUser.role 
                        }
                    ]
                };
                
                // Ajouter aux donn√©es
                rejetsData.push(newRejet);
                saveAllData();
                addLog('info', 'Cr√©ation rejet', `Rejet ${newRejet.reference} cr√©√© par ${currentUser.username}`);
                
                // R√©initialiser le formulaire
                this.reset();
                document.getElementById('reference').value = 'G√©n√©r√© automatiquement';
                
                // R√©initialiser les champs suppl√©mentaires
                saisieConfig.champs_supplementaires.forEach(champ => {
                    const field = document.getElementById(`field-${champ.id}`);
                    if (field) field.value = '';
                });
                
                // Afficher confirmation
                alert(`Rejet ${newRejet.reference} enregistr√© et soumis au superviseur pour validation!`);
                
                // Retour au dashboard
                showPage('dashboard');
            });
            
            // Filtres tableau
            document.getElementById('filter-btn').addEventListener('click', loadRejetsTable);
            
            // Filtre validation
            document.getElementById('validation-filter-type').addEventListener('change', loadValidationTable);
            document.getElementById('refresh-validation').addEventListener('click', loadValidationTable);
            
            // Export Excel
            document.getElementById('export-btn').addEventListener('click', function() {
                let csv = 'Date,R√©f√©rence,Type,D√©partement,Client,Montant,Motif,Agent,Statut\n';
                
                rejetsData.forEach(rejet => {
                    csv += `${rejet.dateSaisie},${rejet.reference},${rejet.type},${getDepartementText(rejet.departement)},`;
                    csv += `"${rejet.clientNom || ''}",${rejet.montant},"${getMotifText(rejet.motif)}",`;
                    csv += `${rejet.agent},${getStatutText(rejet.statut).text}\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `rejets_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                addLog('info', 'Export donn√©es', 'Export CSV des rejets g√©n√©r√©');
                alert('Export CSV g√©n√©r√©!');
            });
            
            // Rapports
            document.getElementById('update-rapport').addEventListener('click', updateRapport);
            document.getElementById('generate-pdf').addEventListener('click', generatePDF);
            document.getElementById('quick-report').addEventListener('click', generateQuickReport);
            
            // Administration
            document.getElementById('add-user-btn').addEventListener('click', () => openUserModal());
            document.getElementById('save-user-btn').addEventListener('click', saveUser);
            document.getElementById('save-config').addEventListener('click', saveConfig);
            document.getElementById('reset-config').addEventListener('click', resetConfig);
            document.getElementById('filter-logs').addEventListener('click', loadLogsTab);
            document.getElementById('export-logs').addEventListener('click', function() {
                let csv = 'Date/Heure,Niveau,Utilisateur,Action,D√©tails,IP\n';
                
                activityLogs.forEach(log => {
                    csv += `${log.timestamp},${log.level},${log.user},${log.action},"${log.details}",${log.ip}\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `logs_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                addLog('info', 'Export logs', 'Journal d\'activit√© export√© en CSV');
                alert('Export des logs g√©n√©r√©!');
            });
            
            // Pagination - changement du nombre de lignes par page
            document.getElementById('rows-per-page-select').addEventListener('change', function() {
                rowsPerPage = parseInt(this.value);
                currentPageRejets = 1;
                updatePagination();
            });
            
            // Initialiser les dates
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            
            // Formulaire de saisie
            document.getElementById('date-operation').valueAsDate = today;
            
            // Filtres
            document.getElementById('filter-date-from').valueAsDate = firstDay;
            document.getElementById('filter-date-to').valueAsDate = today;
            
            // Logs
            document.getElementById('log-date-from').valueAsDate = firstDay;
            document.getElementById('log-date-to').valueAsDate = today;
        }

        // ============================================
        // INITIALISATION
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            
            // Initialiser les donn√©es si vides
            if (rejetsData.length === 0) {
                saveAllData();
            }
            
            // Remplir l'email par d√©faut pour faciliter les tests
            document.getElementById('loginEmail').value = 'sramadan@ecobank.com';
        });
    </script>
</body>
</html>